<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการขายยางก้อนถ้วย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        /* ... CSS อื่นๆ เหมือนเดิม ... */
    </style>
</head>
<body class="bg-stone-100 text-stone-800">
    <script type="module">
    import {
        initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAnalytics
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        collection,
        doc,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        query,
        where,
        getDocs,
        getDoc,
        writeBatch,
        runTransaction,
        orderBy,
        limit,
        enablePersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ... ส่วนของ firebaseConfig, rolePermissions, ui elements เหมือนเดิม ...
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyCNVxG6s46SRXOYAeT0rJHAtz_-3IPUJNE",
        authDomain: "coopksb001.firebaseapp.com",
        projectId: "coopksb001",
        storageBucket: "coopksb001.appspot.com",
        messagingSenderId: "259378610497",
        appId: "1:259378610497:web:fd12679830e97bf5e761c0",
        measurementId: "G-1RHH9TMD73"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'cup-rubber-sales-app';

    const rolePermissions = {
        'admin': ['all', 'tab-activity'],
        'staff': ['tab-weighing-consolidated', 'tab-receipt'],
    };
    
    let displayedSalesData = []; 
    let todaysSalesData = []; 
    let todaysWeighingData = []; 
    let todaysTruckLoads = [];
    let allTimeSummaryData = null; 

    let dailyStatsChart;
    let editingId = null;
    let editingWeighingId = null;

    let db, auth, userId, salesCollectionRef, weighingsCollectionRef, truckLoadsCollectionRef, countersDocRef, summaryDocRef;
    
    let activeListeners = {
        sales: null,
        weighings: null,
        truckLoads: null,
        weighingScales: {}
    };

    let lockStates = {};
    let isAppInitialized = false;

    // ### NOTE: ui elements declarations are here, same as before ###
    const ui = {
        loginScreen: document.getElementById('login-screen'),
        appContainer: document.getElementById('app'),
        loginButton: document.getElementById('login-button'),
        logoutButton: document.getElementById('logout-button'),
        usernameInput: document.getElementById('username-input'),
        passwordInput: document.getElementById('password-input'),
        loginError: document.getElementById('login-error'),
        changePasswordBtn: document.getElementById('change-password-btn'),
        weighingHistoryBody: document.getElementById('weighing-history-body'),
        tabs: document.getElementById('tabs'),
        tabContents: document.querySelectorAll('.tab-content'),
        sellerNameInput: document.getElementById('seller-name'),
        sellerNameList: document.getElementById('seller-name-list'),
        receiptDateInput: document.getElementById('receipt-date'),
        dateDisplay: document.getElementById('date-display'),
        selectedReceiptScale: document.getElementById('selected-receipt-scale'),
        receiptScaleSubTabs: document.getElementById('receipt-scale-sub-tabs'),
        receiptBagsCount: document.getElementById('receipt-bags-count'),
        weightInputsContainer: document.getElementById('weight-inputs-container'),
        pricePerKgInput: document.getElementById('price-per-kg'),
        priceLockBtn: document.getElementById('price-lock-btn'),
        priceLockIcon: document.getElementById('price-lock-icon'),
        typeLockBtn: document.getElementById('type-lock-btn'),
        typeLockIcon: document.getElementById('type-lock-icon'),
        receiptTypeContainer: document.getElementById('receipt-type-container'),
        totalWeightEl: document.getElementById('total-weight'),
        totalAmountEl: document.getElementById('total-amount'),
        totalAmountTextEl: document.getElementById('total-amount-text'),
        saveButton: document.getElementById('save-button'),
        cancelEditButton: document.getElementById('cancel-edit-button'),
        salesTableBody: document.getElementById('sales-table-body'),
        searchBox: document.getElementById('search-box'),
        printArea: document.getElementById('print-area'),
        reportDateSelect: document.getElementById('report-date-select'),
        printReportBtn: document.getElementById('print-report-btn'),
        exportExcelBtn: document.getElementById('export-excel-btn'),
        printDashboardBtn: document.getElementById('print-dashboard-btn'),
        dashboardSection: document.getElementById('dashboard'),
        modal: document.getElementById('modal'),
        modalTitle: document.getElementById('modal-title'),
        modalMessageContainer: document.getElementById('modal-message-container'),
        modalMessage: document.getElementById('modal-message'),
        modalActions: document.getElementById('modal-actions'),
        summaryTotalSellers: document.getElementById('summary-total-sellers'),
        summaryTotalWeight: document.getElementById('summary-total-weight'),
        summaryTotalPrice: document.getElementById('summary-total-price'),
        summaryTotalBags: document.getElementById('summary-total-bags'),
        summaryMultiplierWeight: document.getElementById('summary-multiplier-weight'),
        summaryCalculatedWeight: document.getElementById('summary-calculated-weight'),
        deleteAllWeighingsBtn: document.getElementById('delete-all-weighings-btn'),
        salesSummaryByScale: document.getElementById('sales-summary-by-scale'),
        salesSummaryTodayTotal: document.getElementById('sales-summary-today-total'),
        summaryTodayTotalWeight: document.getElementById('summary-today-total-weight'),
        summaryTodayTotalAmount: document.getElementById('summary-today-total-amount'),
        backupDataBtn: document.getElementById('backup-data-btn'),
        restoreDataBtn: document.getElementById('restore-data-btn'),
        restoreFileInput: document.getElementById('restore-file-input'),
        deleteAllDataBtn: document.getElementById('delete-all-data-btn'),
        truckSummaryDate: document.getElementById('truck-summary-date'),
        truckSummaryContainer: document.getElementById('truck-summary-container'),
        truckGrandTotalWeight: document.getElementById('truck-grand-total-weight'),
        truckTotalLoadedWeight: document.getElementById('truck-total-loaded-weight'),
        truckLoadHistoryContainer: document.getElementById('truck-load-history-container'),
        weighingSubTabs: document.getElementById('weighing-sub-tabs'),
        receiptSubTabs: document.getElementById('receipt-sub-tabs'),
        activitySalesSummaryByScale: document.getElementById('activity-sales-summary-by-scale'),
        activitySalesSummaryTodayTotal: document.getElementById('activity-sales-summary-today-total'),
        activitySummaryTodayTotalWeight: document.getElementById('activity-summary-today-total-weight'),
        activitySummaryTodayTotalAmount: document.getElementById('activity-summary-today-total-amount'),
        activityTruckLoadHistoryContainer: document.getElementById('activity-truck-load-history-container'),
    };
    
    // ### FIX ###: ฟังก์ชันใหม่สำหรับดึงข้อมูลผู้ขายตามวันที่ที่ระบุ
    async function fetchAndPopulateSellerDatalistForDate(date, scaleNumber) {
        if (!date || !scaleNumber) {
            if (ui.sellerNameList) ui.sellerNameList.innerHTML = '';
            return;
        }

        const dateKey = getUTCDateKey(date);
        const startDate = new Date(`${dateKey}T00:00:00.000Z`);
        const endDate = new Date(`${dateKey}T23:59:59.999Z`);

        // 1. ดึงข้อมูลการวางยางของวันนั้น
        const weighingQuery = query(weighingsCollectionRef, 
            where("scaleId", "==", parseInt(scaleNumber)),
            where("timestamp", ">=", startDate),
            where("timestamp", "<=", endDate)
        );

        // 2. ดึงข้อมูลการขายของวันนั้นเพื่อกรองชื่อที่ใช้ไปแล้ว
        const salesQuery = query(salesCollectionRef, 
            where("scaleNumber", "==", scaleNumber),
            where("date", "==", date)
        );

        const [weighingSnap, salesSnap] = await Promise.all([getDocs(weighingQuery), getDocs(salesQuery)]);

        const weighingEntries = weighingSnap.docs.map(d => d.data()).sort((a,b) => (a.dailyQueueNumber || 999) - (b.dailyQueueNumber || 999));
        const sellersWithReceipts = new Set(salesSnap.docs.map(d => d.data().seller));

        const datalist = ui.sellerNameList;
        if (datalist) {
            datalist.innerHTML = '';
            weighingEntries.forEach(entry => {
                // แสดงชื่อใน datalist ถ้ายังไม่มีใบเสร็จ หรือถ้ากำลังแก้ไขรายการของตัวเอง
                const isEditingThisSeller = editingId && ui.sellerNameInput.value === entry.sellerName;
                if (!sellersWithReceipts.has(entry.sellerName) || isEditingThisSeller) {
                    const option = document.createElement('option');
                    option.value = entry.sellerName;
                    datalist.appendChild(option);
                }
            });
        }
    }

    // ### FIX ###: ปรับปรุง clearForm ให้ reset วันที่กลับเป็นวันปัจจุบัน
    function clearForm() {
        ui.sellerNameInput.value = '';
        ui.receiptBagsCount.value = '';
        
        const typeRadios = document.querySelectorAll('.receipt-type-radio');
        typeRadios.forEach(radio => radio.checked = false);

        ui.weightInputsContainer.querySelectorAll('.weight-input').forEach(input => input.value = '');

        const currentScaleId = ui.selectedReceiptScale.value;
        if (currentScaleId && lockStates[currentScaleId] && !lockStates[currentScaleId].price) {
             ui.pricePerKgInput.value = '';
        }
        
        editingId = null;
        ui.saveButton.textContent = 'บันทึกข้อมูล';
        ui.cancelEditButton.classList.add('hidden');
        
        // Reset date to today
        ui.receiptDateInput.valueAsDate = new Date();
        updateDateDisplay();
        
        calculateTotals();
        
        // Repopulate datalist for today
        fetchAndPopulateSellerDatalistForDate(new Date(), currentScaleId);
    }
    
    // ### FIX ###: แก้ไข handleSave เพื่ออัปเดต UI ของข้อมูลย้อนหลัง
    async function handleSave() {
        if (!salesCollectionRef || !countersDocRef) return showAlert('ยังไม่พร้อมใช้งาน กรุณารอสักครู่');
        const seller = ui.sellerNameInput.value.trim();
        const date = ui.receiptDateInput.valueAsDate;
        const scaleNumber = ui.selectedReceiptScale.value;
        const bagsCount = parseInt(ui.receiptBagsCount.value) || 0;
        const weight = parseFloat(ui.totalWeightEl.textContent) || 0;
        const price = parseFloat(ui.pricePerKgInput.value) || 0;
        const total = parseFloat(ui.totalAmountEl.textContent.replace(/,/g, '')) || 0;
        const weightInputs = Array.from(ui.weightInputsContainer.querySelectorAll('.weight-input')).map(input => parseFloat(input.value) || 0).filter(v => v > 0);
        const receiptType = document.querySelector('input[name="receipt_type"]:checked')?.value || null;

        if (!scaleNumber) return showAlert('กรุณาเลือกตาชั่งสำหรับออกใบเสร็จก่อน');
        if (weightInputs.length === 0 || !seller || !date || weight <= 0 || price <= 0) return showAlert('กรุณากรอกข้อมูลให้ครบถ้วน: ชื่อผู้ขาย, วันที่, น้ำหนัก และราคา');
        if (total <= 0) return showAlert('ยอดรวมต้องมากกว่า 0 บาท');
        
        const saleData = { seller, date, scaleNumber, bagsCount, weight, weights: weightInputs, price, total, receiptType, timestamp: new Date(), userId };

        ui.saveButton.disabled = true;
        ui.saveButton.textContent = 'กำลังบันทึก...';

        try {
            if (editingId) {
                const originalDoc = displayedSalesData.find(s => s.id === editingId);
                if (originalDoc) {
                    saleData.dailyQueueNumber = originalDoc.dailyQueueNumber;
                    saleData.receiptId = originalDoc.receiptId;
                    saleData.printCount = originalDoc.printCount || 0;
                    // Keep original timestamp if date is not changed
                    saleData.timestamp = originalDoc.timestamp;
                }
                
                await updateDoc(doc(salesCollectionRef, editingId), saleData);
                
                // ### FIX ###: Manual UI update for historical data
                const index = displayedSalesData.findIndex(s => s.id === editingId);
                if (index > -1) {
                    // Merge updated data with id
                    displayedSalesData[index] = { ...saleData, id: editingId };
                    filterAndRenderSalesTable();
                }

                showAlert('อัปเดตข้อมูลสำเร็จ');
                clearForm();
            } else {
                // Logic for creating a new record remains the same
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(countersDocRef);
                    const dateKey = getUTCDateKey(date);
                    let nextQueueNumber = (counterDoc.exists() && counterDoc.data()[dateKey]) ? counterDoc.data()[dateKey] + 1 : 1;
                    let nextReceiptIndex = (counterDoc.exists() && counterDoc.data().lastReceiptIndex) ? counterDoc.data().lastReceiptIndex + 1 : 1;
                    
                    const now = new Date();
                    const year = now.getFullYear().toString().slice(-2);
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');

                    saleData.dailyQueueNumber = nextQueueNumber;
                    saleData.receiptId = `${year}${month}${day}-${String(nextReceiptIndex).padStart(4, '0')}`;
                    saleData.printCount = 0;

                    const newCounterData = { [dateKey]: nextQueueNumber, lastReceiptIndex: nextReceiptIndex };
                    transaction.set(countersDocRef, newCounterData, { merge: true });
                    transaction.set(doc(salesCollectionRef), saleData);
                });
                showAlert('บันทึกข้อมูลสำเร็จ');
                clearForm();
            }
        } catch (error) {
            console.error("Error saving document: ", error);
            showAlert(`เกิดข้อผิดพลาดในการบันทึก: ${error.message}`);
        } finally {
            ui.saveButton.disabled = false;
            ui.saveButton.textContent = editingId ? 'อัปเดตข้อมูล' : 'บันทึกข้อมูล';
        }
    }

    // ### FIX ###: แก้ไข handleTableClick เพื่ออัปเดต UI ของข้อมูลย้อนหลัง
    function handleTableClick(e) {
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.dataset.id;
        const saleToProcess = displayedSalesData.find(sale => sale.id === id);
        if (!saleToProcess) return;

        if (target.classList.contains('delete-btn')) {
            showConfirm('คุณแน่ใจว่าต้องการลบรายการนี้?', async () => {
                try {
                    await deleteDoc(doc(salesCollectionRef, id));
                    
                    // ### FIX ###: Manual UI update for historical data
                    displayedSalesData = displayedSalesData.filter(s => s.id !== id);
                    filterAndRenderSalesTable();
                    
                    showAlert('ลบรายการสำเร็จ');
                } catch (error) {
                    showAlert(`เกิดข้อผิดพลาดในการลบ: ${error.message}`);
                }
            });
        } else if (target.classList.contains('edit-btn')) {
            editingId = id;
            if (saleToProcess.scaleNumber) {
                const scaleBtn = ui.receiptScaleSubTabs.querySelector(`.receipt-scale-sub-btn[data-scale="${saleToProcess.scaleNumber}"]`);
                if (scaleBtn) scaleBtn.click();
            }
            const saleDate = saleToProcess.date.toDate();
            ui.sellerNameInput.value = saleToProcess.seller;
            ui.receiptBagsCount.value = saleToProcess.bagsCount || '';
            ui.receiptDateInput.value = saleDate.toISOString().split('T')[0];
            ui.pricePerKgInput.value = saleToProcess.price;

            document.querySelectorAll('.receipt-type-radio').forEach(radio => {
                radio.checked = (radio.value === saleToProcess.receiptType);
            });

            const weightInputs = ui.weightInputsContainer.querySelectorAll('.weight-input');
            weightInputs.forEach((input, index) => {
                input.value = saleToProcess.weights[index] || '';
            });

            calculateTotals();
            updateDateDisplay();
            
            // ### FIX ###: Populate datalist for the specific date of the record being edited
            fetchAndPopulateSellerDatalistForDate(saleDate, saleToProcess.scaleNumber);

            ui.saveButton.textContent = 'อัปเดตข้อมูล';
            ui.cancelEditButton.classList.remove('hidden');
            switchToTab('tab-receipt');
            _switchToSubTab('receipt', 'receipt-form');
            window.scrollTo({ top: 0, behavior: 'smooth' });

        } else if (target.classList.contains('reprint-btn')) {
            showConfirm('ยืนยันการพิมพ์ใช่หรือไม่? ระบบจะนับจำนวนครั้งที่พิมพ์', async () => {
                try {
                    const currentCount = saleToProcess.printCount || 0;
                    await updateDoc(doc(salesCollectionRef, id), { printCount: currentCount + 1 });
                    const updatedSaleDataForPrint = { ...saleToProcess, printCount: currentCount + 1 };
                    
                    // ### FIX ###: Manual UI update for historical data
                    saleToProcess.printCount = currentCount + 1;
                    filterAndRenderSalesTable();

                    createPrintableReceipt(updatedSaleDataForPrint);
                } catch (error) {
                    showAlert(`เกิดข้อผิดพลาดในการอัปเดตสถานะ: ${error.message}`);
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const app = initializeApp(firebaseConfig);
        getAnalytics(app);
        auth = getAuth(app);
        db = getFirestore(app);

        try {
            await enablePersistence(db, { synchronizeTabs: true });
            console.log("Firestore persistence enabled.");
        } catch (err) {
            if (err.code == 'failed-precondition') {
                console.warn("Multiple tabs open, persistence can only be enabled in one tab at a a time.");
            } else if (err.code == 'unimplemented') {
                console.warn("The current browser does not support all of the features required to enable persistence.");
            }
        }
        
        // ... (ส่วนของ Event Listeners อื่นๆ เหมือนเดิม) ...
        // ### FIX ###: เพิ่ม event listener ให้กับ date input เพื่ออัปเดต datalist
        ui.receiptDateInput.addEventListener('change', (e) => {
            const selectedDate = e.target.valueAsDate;
            const selectedScale = ui.selectedReceiptScale.value;
            fetchAndPopulateSellerDatalistForDate(selectedDate, selectedScale);
        });

        // ### NOTE: Other event listeners are here, same as before ###
        for (let i = 1; i <= 4; i++) { lockStates[i] = { price: false, type: false }; }
        ui.loginButton.addEventListener('click', handleLogin);
        ui.passwordInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleLogin(); });
        ui.logoutButton.addEventListener('click', handleLogout);
        renderWeighingStations();
        ui.tabs.addEventListener('click', (e) => { if (e.target.dataset.tab) switchToTab(e.target.dataset.tab); });
        ui.saveButton.addEventListener('click', handleSave);
        ui.cancelEditButton.addEventListener('click', clearForm);
        ui.priceLockBtn.addEventListener('click', togglePriceLock);
        ui.typeLockBtn.addEventListener('click', toggleTypeLock);
        ui.salesTableBody.addEventListener('click', handleTableClick);
        ui.printReportBtn.addEventListener('click', createDailySummaryReport);
        ui.exportExcelBtn.addEventListener('click', exportToExcel);
        if (ui.printDashboardBtn) ui.printDashboardBtn.addEventListener('click', () => window.print());
        ui.receiptDateInput.addEventListener('input', updateDateDisplay);
        [...document.querySelectorAll('.weight-input'), ui.pricePerKgInput].forEach(input => input.addEventListener('input', calculateTotals));
        ui.searchBox.addEventListener('input', filterAndRenderSalesTable);
        ui.reportDateSelect.addEventListener('change', (e) => fetchSalesDataForDate(e.target.value));
        ui.summaryMultiplierWeight.addEventListener('input', calculateSummaryTotalWeight);
        ui.deleteAllWeighingsBtn.addEventListener('click', deleteAllTodaysWeighings);
        ui.backupDataBtn.addEventListener('click', backupData);
        ui.restoreDataBtn.addEventListener('click', () => ui.restoreFileInput.click());
        ui.restoreFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) restoreDataFromFile(file);
            e.target.value = '';
        });
        ui.deleteAllDataBtn.addEventListener('click', confirmDeleteAllData);
        ui.truckSummaryDate.addEventListener('change', calculateTruckSummary);
        ui.truckSummaryContainer.addEventListener('click', (e) => { if (e.target.closest('.save-load-btn')) handleSaveTruckLoad(e); });
        ui.truckLoadHistoryContainer.addEventListener('click', handleTruckLoadHistoryClick);
        ui.activityTruckLoadHistoryContainer.addEventListener('click', handleTruckLoadHistoryClick);
        ui.receiptDateInput.valueAsDate = new Date();
        updateDateDisplay();
        ui.receiptScaleSubTabs.addEventListener('click', (e) => {
            const targetBtn = e.target.closest('.receipt-scale-sub-btn');
            if (targetBtn) {
                const scale = targetBtn.dataset.scale;
                document.querySelectorAll('.receipt-scale-sub-btn').forEach(btn => btn.classList.remove('active'));
                targetBtn.classList.add('active');
                ui.selectedReceiptScale.value = scale;
                applyLockState(scale);
                // ### FIX ###: Use the date from the form to populate the datalist
                fetchAndPopulateSellerDatalistForDate(ui.receiptDateInput.valueAsDate, scale);
                ui.sellerNameInput.value = '';
                ui.receiptBagsCount.value = '';
                ui.sellerNameInput.focus();
            }
        });
        ui.sellerNameInput.addEventListener('input', async (e) => {
            const selectedName = e.target.value;
            const scaleNumber = ui.selectedReceiptScale.value;
            const selectedDate = ui.receiptDateInput.valueAsDate;
            if (!selectedName || !scaleNumber || !selectedDate) return;
            
            const dateKey = getUTCDateKey(selectedDate);
            const startDate = new Date(`${dateKey}T00:00:00Z`);
            const endDate = new Date(`${dateKey}T23:59:59Z`);

            const q = query(weighingsCollectionRef, 
                where("scaleId", "==", parseInt(scaleNumber)), 
                where("sellerName", "==", selectedName),
                where("timestamp", ">=", startDate),
                where("timestamp", "<=", endDate),
                limit(1)
            );
            const weighingSnap = await getDocs(q);

            if (!weighingSnap.empty) {
                ui.receiptBagsCount.value = weighingSnap.docs[0].data().bags;
            }
        });

        ui.weighingSubTabs.addEventListener('click', (e) => { if (e.target.dataset.subtab) _switchToSubTab('weighing', e.target.dataset.subtab); });
        ui.receiptSubTabs.addEventListener('click', (e) => { if (e.target.dataset.subtab) _switchToSubTab('receipt', e.target.dataset.subtab); });
        _switchToSubTab('weighing', 'weighing-scale-1');
        _switchToSubTab('receipt', 'receipt-form');
        const firstReceiptScaleTab = ui.receiptScaleSubTabs.querySelector('.receipt-scale-sub-btn');
        if (firstReceiptScaleTab) firstReceiptScaleTab.click();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                ui.loginScreen.classList.add('hidden');
                ui.appContainer.classList.remove('hidden');
                ui.usernameInput.value = '';

                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                let userRole = 'staff';
                if (userDocSnap.exists()) {
                    userRole = userDocSnap.data().role || 'staff';
                }
                
                initializeAppAndListeners(user, userRole);
            } else {
                ui.loginScreen.classList.remove('hidden');
                ui.appContainer.classList.add('hidden');
                cleanupListeners();
            }
        });
    });

    // ### NOTE ###: The rest of the functions (which were already correct) should be placed here.
    // Examples: getUTCDateKey, initializeAppAndListeners, handleLogin, handleLogout, all printing functions, modal functions, etc.
    // The previous response's functions that are not marked with a "FIX" can be copied here.
    // ...
    // (The remaining unchanged functions from the previous version go here)
    // ...

</script>
</body>
</html>
