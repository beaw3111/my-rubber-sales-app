<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการขายยางก้อนถ้วย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .tab-btn {
            transition: all 0.3s ease-in-out;
        }

        .tab-btn.active {
            border-color: #d97706;
            background-color: #fffbeb;
            color: #b45309;
            font-weight: 700;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* Styling for sub-tab buttons in "รับวางยาง" */
        .weighing-sub-btn {
            transition: all 0.15s ease-in-out;
        }

        .weighing-sub-btn.active {
            background-color: #b45309; /* amber-700 */
            color: #ffffff;
            transform: translateY(1px);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
        }

        .weighing-sub-content {
            display: none;
        }

        .weighing-sub-content.active {
            display: block;
        }

        /* Styling for sub-tab buttons in "ออกใบเสร็จ" */
        .receipt-sub-btn {
            transition: all 0.15s ease-in-out;
        }

        .receipt-sub-btn.active {
            background-color: #b45309; /* amber-700 */
            color: #ffffff;
            transform: translateY(1px);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
        }

        .receipt-sub-content {
            display: none;
        }

        .receipt-sub-content.active {
            display: block;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }

            .no-print {
                display: none !important;
            }

            .watermark {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 3em;
                color: rgba(0, 0, 0, 0.1);
                pointer-events: none;
                white-space: nowrap;
                z-index: 10;
            }
        }
    </style>
</head>

<body class="bg-stone-100 text-stone-800">
    <div id="app" class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <header class="relative mb-10 text-center">
            <h1 class="text-4xl font-bold text-stone-900">ระบบจัดการขายยางก้อนถ้วย</h1>
            <p class="text-xl font-semibold text-stone-700 mt-2">สหกรณ์กองทุนสวนยางพาราเกษตรสมบูรณ์ จำกัด</p>
            <p class="text-stone-600 mt-2">ออกใบเสร็จ บันทึกข้อมูล และดูสรุปยอดขายในที่เดียว</p>
            <button id="logout-button" class="absolute top-0 right-0 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition-colors no-print">
                ออกจากระบบ
            </button>
        </header>

        <div class="mb-6 border-b border-stone-300 no-print">
            <nav id="tabs" class="flex flex-wrap -mb-px">
                <button data-tab="tab-weighing-consolidated" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">1. รับวางยาง</button>
                <button data-tab="tab-receipt" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300 active">2. ออกใบเสร็จ และ สรุปขึ้นรถ</button>
                <button data-tab="tab-history" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">3. ประวัติและรายงาน</button>
                <button data-tab="tab-dashboard" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">4. สรุปภาพรวม</button>
                <button data-tab="tab-settings" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">5. ตั้งค่า</button>
            </nav>
        </div>

        <main>
            <div id="tab-weighing-consolidated" class="tab-content"></div>
            
            <div id="tab-receipt" class="tab-content active">
                <div id="receipt-sub-tabs" class="mb-6">
                    <nav class="flex flex-wrap gap-2" aria-label="Receipt Tabs">
                        <button data-subtab="receipt-form" class="receipt-sub-btn py-2 px-5 rounded-lg bg-stone-100 hover:bg-stone-200 text-stone-700 font-semibold shadow-sm border border-stone-200 active">ออกใบเสร็จ</button>
                        <button data-subtab="receipt-truck-summary" class="receipt-sub-btn py-2 px-5 rounded-lg bg-stone-100 hover:bg-stone-200 text-stone-700 font-semibold shadow-sm border border-stone-200">สรุปรวมขึ้นรถ</button>
                    </nav>
                </div>

                <div id="receipt-form-content" class="receipt-sub-content active">
                     <section id="receipt-generator" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2 border-b pb-3 text-stone-800">2. กรอกข้อมูลเพื่อออกใบเสร็จ</h2>
                        <p class="text-sm text-stone-500 mt-2 mb-6">ส่วนนี้คือศูนย์กลางการทำงาน สำหรับบันทึกข้อมูลการขาย ระบบจะคำนวณยอดรวมให้อัตโนมัติ และเมื่อบันทึกข้อมูลแล้วจะสร้างใบเสร็จสำหรับพิมพ์ได้ทันที</p>
                        </section>
                </div>

                <div id="receipt-truck-summary-content" class="receipt-sub-content">
                    <h2 class="text-2xl font-bold mb-4 text-stone-800">สรุปรวมยอดขายทั้งหมด (วันนี้)</h2>
                    
                    <div id="receipt-scale-summary-container">
                        </div>
                    </div>
            </div>

            <div id="tab-history" class="tab-content"></div>

            <div id="tab-dashboard" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-stone-800">สรุปภาพรวมทั้งหมด</h2>

                <div id="dashboard-scale-summary-container" class="mb-8">
                    </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <section class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">กราฟสรุปยอดขายรายวัน</h3>
                        <div class="chart-container">
                            <canvas id="daily-sales-chart"></canvas>
                        </div>
                    </section>
                    <section class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">ข้อมูลอื่นๆ</h3>
                        <p>ส่วนแสดงผลข้อมูลสรุปอื่นๆ จะอยู่ที่นี่</p>
                    </section>
                </div>
            </div>

            <div id="tab-settings" class="tab-content"></div>

        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- MOCK DATA and FUNCTIONS for Demonstration ---
    // In a real application, this data would come from localStorage or a server.
    let mockSalesData = [];

    function saveMockSale(sale) {
        mockSalesData.push(sale);
        // This is the key step: after data changes, re-render the summaries.
        renderDailyScaleSummary();
    }

    // Simulate saving a few sales to demonstrate the feature
    function simulateInitialData() {
        const today = new Date().toISOString().slice(0, 10);
        saveMockSale({ date: today, scale: 1, weights: [120, 110], total: 230 });
        saveMockSale({ date: today, scale: 3, weights: [150], total: 150 });
        saveMockSale({ date: today, scale: 1, weights: [80], total: 80 });
        saveMockSale({ date: today, scale: 2, weights: [200, 205], total: 405 });
    }

    // --- CORE LOGIC ---

    /**
     * Calculates and renders the "Sales Summary by Scale (Today)" table.
     * This single function updates BOTH locations to ensure they are always in sync.
     */
    function renderDailyScaleSummary() {
        // Find the two container elements where the summary should be displayed.
        const receiptContainer = document.getElementById('receipt-scale-summary-container');
        const dashboardContainer = document.getElementById('dashboard-scale-summary-container');

        // Exit if the containers don't exist (safety check).
        if (!receiptContainer || !dashboardContainer) {
            console.error("Summary container(s) not found!");
            return;
        }

        const today = new Date().toISOString().slice(0, 10);
        const todaysSales = mockSalesData.filter(sale => sale.date === today);

        // Group sales by scale number and calculate totals.
        const summary = todaysSales.reduce((acc, sale) => {
            if (!acc[sale.scale]) {
                acc[sale.scale] = { totalWeight: 0, count: 0 };
            }
            acc[sale.scale].totalWeight += sale.total;
            acc[sale.scale].count += 1; // Count of receipts for that scale
            return acc;
        }, {});

        // --- Generate the HTML for the summary table ---
        let contentHtml;
        if (Object.keys(summary).length === 0) {
            contentHtml = `
                <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-stone-800">สรุปยอดขายแยกตามตาชั่ง (วันนี้)</h3>
                    <p class="text-stone-500">ยังไม่มีข้อมูลสำหรับวันนี้</p>
                </section>
            `;
        } else {
            const tableRows = Object.keys(summary).sort((a, b) => a - b).map(scale => `
                <tr class="border-b border-stone-200 hover:bg-stone-50">
                    <td class="p-3 text-center">${scale}</td>
                    <td class="p-3 text-center">${summary[scale].count.toLocaleString()}</td>
                    <td class="p-3 text-right font-semibold text-amber-700">${summary[scale].totalWeight.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `).join('');

            const grandTotal = Object.values(summary).reduce((sum, data) => sum + data.totalWeight, 0);

            contentHtml = `
                <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-stone-800">สรุปยอดขายแยกตามตาชั่ง (วันนี้)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-stone-100 text-sm font-semibold text-stone-600">
                                <tr>
                                    <th class="p-3 text-center">ตาชั่งที่</th>
                                    <th class="p-3 text-center">จำนวนใบเสร็จ</th>
                                    <th class="p-3 text-right">น้ำหนักรวม (กก.)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                            <tfoot class="font-bold text-lg">
                                <tr class="border-t-2 border-stone-300">
                                    <td colspan="2" class="p-4 text-right">รวมทั้งหมด</td>
                                    <td class="p-4 text-right text-blue-700">${grandTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </section>
            `;
        }

        // --- Inject the generated HTML into BOTH containers ---
        receiptContainer.innerHTML = contentHtml;
        dashboardContainer.innerHTML = contentHtml;
    }


    // --- Tab and Sub-Tab Navigation Logic ---
    function setupTabs() {
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
    }

    function setupSubTabs(containerId, btnClass, contentClass) {
        const subTabContainer = document.getElementById(containerId);
        if (!subTabContainer) return;

        const subTabs = subTabContainer.querySelectorAll(`.${btnClass}`);
        const subTabContents = subTabContainer.parentElement.querySelectorAll(`.${contentClass}`);
        
        subTabs.forEach(subTab => {
            subTab.addEventListener('click', () => {
                subTabs.forEach(st => st.classList.remove('active'));
                subTab.classList.add('active');
                
                subTabContents.forEach(content => content.classList.remove('active'));
                
                const contentId = `${subTab.dataset.subtab}-content`;
                document.getElementById(contentId)?.classList.add('active');
            });
        });
    }
    
    // Initialize everything
    setupTabs();
    setupSubTabs('receipt-sub-tabs', 'receipt-sub-btn', 'receipt-sub-content');
    // Call other setup functions if they exist...

    // Initial render of the summaries on page load.
    simulateInitialData(); // Load some demo data
    // The last call to `saveMockSale` inside `simulateInitialData` already triggers renderDailyScaleSummary.
});
</script>

</body>

</html>
