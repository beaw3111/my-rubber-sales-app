<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการขายยางก้อนถ้วย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .tab-btn {
            transition: all 0.3s ease-in-out;
        }
        .tab-btn.active {
            border-color: #d97706;
            background-color: #fffbeb;
            color: #b45309;
            font-weight: 700;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .weighing-sub-btn {
            transition: all 0.15s ease-in-out;
        }
        .weighing-sub-btn.active {
            background-color: #b45309;
            color: #ffffff;
            transform: translateY(1px);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
        }
        .weighing-sub-content {
            display: none;
        }
        .weighing-sub-content.active {
            display: block;
        }
        .receipt-sub-btn {
            transition: all 0.15s ease-in-out;
        }
        .receipt-sub-btn.active {
            background-color: #b45309;
            color: #ffffff;
            transform: translateY(1px);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
        }
        .receipt-sub-content {
            display: none;
        }
        .receipt-sub-content.active {
            display: block;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area,
            #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .no-print {
                display: none !important;
            }
            .watermark {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 3em;
                color: rgba(0, 0, 0, 0.1);
                pointer-events: none;
                white-space: nowrap;
                z-index: 10;
            }
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-stone-800 mb-2">ระบบจัดการขายยางก้อนถ้วย</h2>
            <p class="text-center text-stone-500 mb-6">กรุณาเข้าสู่ระบบ</p>
            <div class="space-y-4">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-stone-600">ชื่อผู้ใช้</label>
                    <input type="text" id="username-input" class="mt-1 w-full p-3 border border-stone-300 rounded-lg shadow-sm focus:ring-2 focus:ring-amber-500">
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-stone-600">รหัสผ่าน</label>
                    <input type="password" id="password-input" class="mt-1 w-full p-3 border border-stone-300 rounded-lg shadow-sm focus:ring-2 focus:ring-amber-500">
                </div>
                <p id="login-error" class="text-sm text-red-600 text-center hidden"></p>
                <button id="login-button" class="w-full bg-amber-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-amber-700 transition-colors">เข้าสู่ระบบ</button>
            </div>
            <div class="text-center mt-4">
                <button id="change-password-btn" class="text-sm text-stone-500 hover:text-amber-600 underline">เปลี่ยนรหัสผ่าน</button>
            </div>
        </div>
    </div>

    <div id="app" class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 hidden">
        <header class="relative mb-10 text-center">
            <h1 class="text-4xl font-bold text-stone-900">ระบบจัดการขายยางก้อนถ้วย</h1>
            <p class="text-xl font-semibold text-stone-700 mt-2">สหกรณ์กองทุนสวนยางพาราเกษตรสมบูรณ์ จำกัด</p>
            <p class="text-stone-600 mt-2">ออกใบเสร็จ บันทึกข้อมูล และดูสรุปยอดขายในที่เดียว</p>
            <button id="logout-button" class="absolute top-0 right-0 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition-colors no-print">ออกจากระบบ</button>
        </header>

        <div class="mb-6 border-b border-stone-300 no-print">
            <nav id="tabs" class="flex flex-wrap -mb-px">
                <button data-tab="tab-weighing-consolidated" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">1. รับวางยาง</button>
                <button data-tab="tab-receipt" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">2. ออกใบเสร็จ และ สรุปขึ้นรถ</button>
                <button data-tab="tab-history" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">3. ประวัติและรายงาน</button>
                <button data-tab="tab-dashboard" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">4. สรุปภาพรวม</button>
                <button data-tab="tab-settings" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">5. ตั้งค่า</button>
            </nav>
        </div>

        <main>
            <div id="tab-receipt" class="tab-content">
                <div id="receipt-sub-tabs" class="mb-6 no-print">
                    <nav class="flex flex-wrap gap-2" aria-label="Receipt Tabs">
                        <button data-subtab="receipt-form" class="receipt-sub-btn py-2 px-5 rounded-lg bg-stone-100 hover:bg-stone-200 text-stone-700 font-semibold shadow-sm border border-stone-200">ออกใบเสร็จ</button>
                        <button data-subtab="receipt-truck-summary" class="receipt-sub-btn py-2 px-5 rounded-lg bg-stone-100 hover:bg-stone-200 text-stone-700 font-semibold shadow-sm border border-stone-200">สรุปรวมขึ้นรถ</button>
                    </nav>
                </div>
                <div id="receipt-form-content" class="receipt-sub-content">
                    <section id="receipt-generator" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2 border-b pb-3 text-stone-800">2. กรอกข้อมูลเพื่อออกใบเสร็จ</h2>
                        <p class="text-sm text-stone-500 mt-2 mb-6">กรอกข้อมูลการขาย หรือเลือกจากประวัติการวางยาง เพื่อสร้างใบเสร็จและบันทึกข้อมูล</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
                                <div class="sm:col-span-2">
                                    <label for="seller-name" class="block text-sm font-medium text-stone-700 mb-1">ชื่อ-สกุล ผู้ขาย</label>
                                    <input type="text" id="seller-name" class="w-full p-3 border border-stone-300 rounded-lg shadow-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="พิมพ์ หรือ เลือกจากประวัติ ->">
                                </div>
                                <div>
                                    <button id="select-from-history-btn" class="w-full p-3 bg-sky-600 text-white font-semibold rounded-lg shadow-sm hover:bg-sky-700 transition-colors">เลือกจากประวัติ</button>
                                </div>
                            </div>
                            </div>
                    </section>
                </div>
                </div>
            </main>
    </div>

    <div id="print-area" class="bg-white"></div>
    <div id="modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300 no-print" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, getDoc, writeBatch, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Config and Global Variables ---
        const firebaseConfig = { /* ... your config ... */ };
        const appId = 'cup-rubber-sales-app';
        const users = { /* ... user details ... */ };
        let currentPassword = localStorage.getItem('customPassword') || users.admin.password;
        users.admin.password = currentPassword;
        
        let localSalesData = [];
        let localWeighingData = [];
        let localTruckLoads = [];
        let db, auth, userId, salesCollectionRef, weighingsCollectionRef, truckLoadsCollectionRef, countersDocRef;
        // ... other global variables ...

        const ui = {
            // ... all existing ui elements ...
            selectFromHistoryBtn: document.getElementById('select-from-history-btn'),
        };
        
        // [EDITED] Rewritten function to handle filtering
        function showWeighingHistoryModal() {
            if (localWeighingData.length === 0) {
                return showAlert('ไม่มีข้อมูลการวางยางในคิว');
            }

            const uniqueDates = Array.from(new Set(localWeighingData.map(r => r.timestamp.toDate().toISOString().split('T')[0])))
                .sort((a, b) => new Date(b) - new Date(a));

            const modalHTML = `
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <select id="history-date-filter" class="w-full sm:w-1/2 p-2 border border-stone-300 rounded-md">
                            <option value="">-- ทุกวันที่ --</option>
                            ${uniqueDates.map(dateStr => {
                                const d = new Date(dateStr);
                                return `<option value="${dateStr}">${d.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}</option>`
                            }).join('')}
                        </select>
                        <select id="history-scale-filter" class="w-full sm:w-1/2 p-2 border border-stone-300 rounded-md">
                            <option value="">-- ทุกตาชั่ง --</option>
                            <option value="1">ตาชั่ง 1</option>
                            <option value="2">ตาชั่ง 2</option>
                            <option value="3">ตาชั่ง 3</option>
                            <option value="4">ตาชั่ง 4</option>
                        </select>
                    </div>
                    <input type="text" id="history-search" class="w-full p-2 border border-stone-300 rounded-md" placeholder="🔍 ค้นหาชื่อ...">
                    <ul id="weighing-history-list" class="max-h-80 overflow-y-auto space-y-2">
                        </ul>
                </div>
            `;

            showModal('เลือกจากประวัติการวางยาง', modalHTML, [{
                text: 'ยกเลิก',
                classes: 'mt-3 w-full inline-flex justify-center rounded-md border border-stone-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-stone-700 hover:bg-stone-50 sm:mt-0 sm:w-auto sm:text-sm'
            }]);

            const dateFilter = document.getElementById('history-date-filter');
            const scaleFilter = document.getElementById('history-scale-filter');
            const searchInput = document.getElementById('history-search');
            const listContainer = document.getElementById('weighing-history-list');

            const renderHistoryList = () => {
                const selectedDate = dateFilter.value;
                const selectedScale = scaleFilter.value;
                const searchTerm = searchInput.value.toLowerCase();

                const filteredData = localWeighingData.filter(record => {
                    const recordDateStr = record.timestamp.toDate().toISOString().split('T')[0];
                    const dateMatch = !selectedDate || recordDateStr === selectedDate;
                    const scaleMatch = !selectedScale || record.scaleId.toString() === selectedScale;
                    const searchMatch = !searchTerm || record.sellerName.toLowerCase().includes(searchTerm);
                    return dateMatch && scaleMatch && searchMatch;
                });

                // Sort the final filtered list
                filteredData.sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate());

                if (filteredData.length === 0) {
                    listContainer.innerHTML = `<li class="p-4 text-center text-stone-400">ไม่พบรายการที่ตรงกับตัวกรอง</li>`;
                    return;
                }

                listContainer.innerHTML = filteredData.map(record => {
                    const timestamp = record.timestamp.toDate();
                    const recordData = JSON.stringify({
                        sellerName: record.sellerName,
                        bags: record.bags,
                        docId: record.id
                    });
                    return `
                        <li class="p-3 border rounded-lg hover:bg-amber-50 cursor-pointer history-item" data-record='${recordData}'>
                            <p class="font-bold text-stone-800">${record.sellerName}</p>
                            <div class="text-sm text-stone-500 flex justify-between">
                                <span>จำนวน: ${record.bags} ถุง (ตาชั่ง ${record.scaleId})</span>
                                <span>${timestamp.toLocaleDateString('th-TH')}</span>
                            </div>
                        </li>`;
                }).join('');
            };

            // Add event listeners
            dateFilter.addEventListener('change', renderHistoryList);
            scaleFilter.addEventListener('change', renderHistoryList);
            searchInput.addEventListener('input', renderHistoryList);

            listContainer.addEventListener('click', (e) => {
                const selectedItem = e.target.closest('.history-item');
                if (!selectedItem) return;

                const record = JSON.parse(selectedItem.dataset.record);

                ui.sellerNameInput.value = record.sellerName;
                const weightInputs = ui.weightInputsContainer.querySelectorAll('.weight-input');
                weightInputs.forEach(input => input.value = ''); 
                if (weightInputs.length > 0) {
                    weightInputs[0].value = record.bags; 
                }
                
                calculateTotals();
                hideModal();

                const confirmMessage = `คุณได้เลือก <strong>${record.sellerName}</strong> (${record.bags} ถุง)<br><br><strong>ยืนยันเพื่อลบรายการนี้ออกจากคิววางยางหรือไม่?</strong> (เพื่อป้องกันการทำใบเสร็จซ้ำ)`;
                showConfirm(confirmMessage, async () => {
                    try {
                        await deleteDoc(doc(weighingsCollectionRef, record.docId));
                        showAlert('ลบข้อมูลการวางยางออกจากคิวเรียบร้อยแล้ว');
                    } catch (error) {
                        showAlert(`เกิดข้อผิดพลาดในการลบข้อมูลออกจากคิว: ${error.message}`);
                    }
                });
            });

            // Initial render
            renderHistoryList();
        }

        // --- Other Functions ---
        // ... (All other functions like handleSave, renderTable, etc. remain here) ...


        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (All other event listeners like login, logout, etc. remain here) ...
            
            // [EDITED] Connect the button to the new modal function
            ui.selectFromHistoryBtn.addEventListener('click', showWeighingHistoryModal);

            // ... (rest of the DOMContentLoaded code) ...
        });
    </script>
</body>
</html>
