<script type="module">
Â  Â  import {
Â  Â  Â  Â  initializeApp
Â  Â  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  import {
Â  Â  Â  Â  getAnalytics
Â  Â  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
Â  Â  import {
Â  Â  Â  Â  getAuth,
Â  Â  Â  Â  onAuthStateChanged,
Â  Â  Â  Â  signInWithEmailAndPassword,
Â  Â  Â  Â  signOut
Â  Â  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  import {
Â  Â  Â  Â  getFirestore,
Â  Â  Â  Â  collection,
Â  Â  Â  Â  doc,
Â  Â  Â  Â  addDoc,
Â  Â  Â  Â  updateDoc,
Â  Â  Â  Â  deleteDoc,
Â  Â  Â  Â  onSnapshot,
Â  Â  Â  Â  query,
Â  Â  Â  Â  where,
Â  Â  Â  Â  getDocs,
Â  Â  Â  Â  getDoc,
Â  Â  Â  Â  writeBatch,
Â  Â  Â  Â  runTransaction
Â  Â  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

Â  Â  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
Â  Â  Â  Â  apiKey: "AIzaSyCNVxG6s46SRXOYAeT0rJHAtz_-3IPUJNE",
Â  Â  Â  Â  authDomain: "coopksb001.firebaseapp.com",
Â  Â  Â  Â  projectId: "coopksb001",
Â  Â  Â  Â  storageBucket: "coopksb001.appspot.com",
Â  Â  Â  Â  messagingSenderId: "259378610497",
Â  Â  Â  Â  appId: "1:259378610497:web:fd12679830e97bf5e761c0",
Â  Â  Â  Â  measurementId: "G-1RHH9TMD73"
Â  Â  };
Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'cup-rubber-sales-app';

Â  Â  const rolePermissions = {
Â  Â  Â  Â  'admin': ['all', 'tab-activity'],
Â  Â  Â  Â  'staff': ['tab-weighing-consolidated', 'tab-receipt'],
Â  Â  };

Â  Â  let localSalesData = [];
Â  Â  let localWeighingData = [];
Â  Â  let localTruckLoads = [];
Â  Â  let dailyStatsChart;
Â  Â  let editingId = null;
Â  Â  let editingWeighingId = null;

Â  Â  let db, auth, userId, salesCollectionRef, weighingsCollectionRef, truckLoadsCollectionRef, countersDocRef;
Â  Â  let unsubscribeSales = null;
Â  Â  let unsubscribeAllWeighings = null;
Â  Â  let unsubscribeTruckLoads = null;
Â  Â  let unsubscribeWeighings = {};

Â  Â  let dailyWeighingData = {};
    
    // ### MODIFIED ###: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸•à¸±à¸§à¹à¸›à¸£à¸¥à¹‡à¸­à¸„à¹€à¸›à¹‡à¸™ Object à¹€à¸à¸·à¹ˆà¸­à¹€à¸à¹‡à¸šà¸ªà¸–à¸²à¸™à¸°à¹à¸¢à¸à¸•à¸²à¸¡à¸•à¸²à¸Šà¸±à¹ˆà¸‡
Â  Â  let lockStates = {};
Â  Â  let isAppInitialized = false;

Â  Â  const ui = {
Â  Â  Â  Â  loginScreen: document.getElementById('login-screen'),
Â  Â  Â  Â  appContainer: document.getElementById('app'),
Â  Â  Â  Â  loginButton: document.getElementById('login-button'),
Â  Â  Â  Â  logoutButton: document.getElementById('logout-button'),
Â  Â  Â  Â  usernameInput: document.getElementById('username-input'),
Â  Â  Â  Â  passwordInput: document.getElementById('password-input'),
Â  Â  Â  Â  loginError: document.getElementById('login-error'),
Â  Â  Â  Â  changePasswordBtn: document.getElementById('change-password-btn'),
Â  Â  Â  Â  weighingHistoryBody: document.getElementById('weighing-history-body'),
Â  Â  Â  Â  tabs: document.getElementById('tabs'),
Â  Â  Â  Â  tabContents: document.querySelectorAll('.tab-content'),
Â  Â  Â  Â  sellerNameInput: document.getElementById('seller-name'),
Â  Â  Â  Â  sellerNameList: document.getElementById('seller-name-list'),
Â  Â  Â  Â  receiptDateInput: document.getElementById('receipt-date'),
Â  Â  Â  Â  dateDisplay: document.getElementById('date-display'),
Â  Â  Â  Â  selectedReceiptScale: document.getElementById('selected-receipt-scale'),
Â  Â  Â  Â  receiptScaleSubTabs: document.getElementById('receipt-scale-sub-tabs'),
Â  Â  Â  Â  receiptBagsCount: document.getElementById('receipt-bags-count'),
Â  Â  Â  Â  weightInputsContainer: document.getElementById('weight-inputs-container'),
Â  Â  Â  Â  pricePerKgInput: document.getElementById('price-per-kg'),
Â  Â  Â  Â  priceLockBtn: document.getElementById('price-lock-btn'),
Â  Â  Â  Â  priceLockIcon: document.getElementById('price-lock-icon'),
Â  Â  Â  Â  typeLockBtn: document.getElementById('type-lock-btn'),
Â  Â  Â  Â  typeLockIcon: document.getElementById('type-lock-icon'),
Â  Â  Â  Â  receiptTypeContainer: document.getElementById('receipt-type-container'),
Â  Â  Â  Â  totalWeightEl: document.getElementById('total-weight'),
Â  Â  Â  Â  totalAmountEl: document.getElementById('total-amount'),
Â  Â  Â  Â  totalAmountTextEl: document.getElementById('total-amount-text'),
Â  Â  Â  Â  saveButton: document.getElementById('save-button'),
Â  Â  Â  Â  cancelEditButton: document.getElementById('cancel-edit-button'),
Â  Â  Â  Â  salesTableBody: document.getElementById('sales-table-body'),
Â  Â  Â  Â  searchBox: document.getElementById('search-box'),
Â  Â  Â  Â  printArea: document.getElementById('print-area'),
Â  Â  Â  Â  reportDateSelect: document.getElementById('report-date-select'),
Â  Â  Â  Â  printReportBtn: document.getElementById('print-report-btn'),
Â  Â  Â  Â  exportExcelBtn: document.getElementById('export-excel-btn'),
Â  Â  Â  Â  printDashboardBtn: document.getElementById('print-dashboard-btn'),
Â  Â  Â  Â  dashboardSection: document.getElementById('dashboard'),
Â  Â  Â  Â  modal: document.getElementById('modal'),
Â  Â  Â  Â  modalTitle: document.getElementById('modal-title'),
Â  Â  Â  Â  modalMessageContainer: document.getElementById('modal-message-container'),
Â  Â  Â  Â  modalMessage: document.getElementById('modal-message'),
Â  Â  Â  Â  modalActions: document.getElementById('modal-actions'),
Â  Â  Â  Â  summaryTotalSellers: document.getElementById('summary-total-sellers'),
Â  Â  Â  Â  summaryTotalWeight: document.getElementById('summary-total-weight'),
Â  Â  Â  Â  summaryTotalPrice: document.getElementById('summary-total-price'),
Â  Â  Â  Â  summaryTotalBags: document.getElementById('summary-total-bags'),
Â  Â  Â  Â  summaryMultiplierWeight: document.getElementById('summary-multiplier-weight'),
Â  Â  Â  Â  summaryCalculatedWeight: document.getElementById('summary-calculated-weight'),
Â  Â  Â  Â  deleteAllWeighingsBtn: document.getElementById('delete-all-weighings-btn'),
Â  Â  Â  Â  salesSummaryByScale: document.getElementById('sales-summary-by-scale'),
Â  Â  Â  Â  salesSummaryTodayTotal: document.getElementById('sales-summary-today-total'),
Â  Â  Â  Â  summaryTodayTotalWeight: document.getElementById('summary-today-total-weight'),
Â  Â  Â  Â  summaryTodayTotalAmount: document.getElementById('summary-today-total-amount'),
Â  Â  Â  Â  backupDataBtn: document.getElementById('backup-data-btn'),
Â  Â  Â  Â  restoreDataBtn: document.getElementById('restore-data-btn'),
Â  Â  Â  Â  restoreFileInput: document.getElementById('restore-file-input'),
Â  Â  Â  Â  deleteAllDataBtn: document.getElementById('delete-all-data-btn'),
Â  Â  Â  Â  truckSummaryDate: document.getElementById('truck-summary-date'),
Â  Â  Â  Â  truckSummaryContainer: document.getElementById('truck-summary-container'),
Â  Â  Â  Â  truckGrandTotalWeight: document.getElementById('truck-grand-total-weight'),
Â  Â  Â  Â  truckTotalLoadedWeight: document.getElementById('truck-total-loaded-weight'),
Â  Â  Â  Â  truckLoadHistoryContainer: document.getElementById('truck-load-history-container'),
Â  Â  Â  Â  weighingSubTabs: document.getElementById('weighing-sub-tabs'),
Â  Â  Â  Â  receiptSubTabs: document.getElementById('receipt-sub-tabs'),
Â  Â  Â  Â  activitySalesSummaryByScale: document.getElementById('activity-sales-summary-by-scale'),
Â  Â  Â  Â  activitySalesSummaryTodayTotal: document.getElementById('activity-sales-summary-today-total'),
Â  Â  Â  Â  activitySummaryTodayTotalWeight: document.getElementById('activity-summary-today-total-weight'),
Â  Â  Â  Â  activitySummaryTodayTotalAmount: document.getElementById('activity-summary-today-total-amount'),
Â  Â  Â  Â  activityTruckLoadHistoryContainer: document.getElementById('activity-truck-load-history-container'),
Â  Â  };
Â  Â Â 
Â  Â  function applyUserPermissions(userRole) {
Â  Â  Â  Â  const permissions = rolePermissions[userRole] || [];
Â  Â  Â  Â  const allTabButtons = document.querySelectorAll('#tabs .tab-btn');
Â  Â  Â  Â  let firstVisibleTab = null;

Â  Â  Â  Â  allTabButtons.forEach(btn => {
Â  Â  Â  Â  Â  Â  const tabId = btn.dataset.tab;
Â  Â  Â  Â  Â  Â  if (userRole === 'admin' || permissions.includes('all') || permissions.includes(tabId)) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  if (!firstVisibleTab) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  firstVisibleTab = tabId;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  btn.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (firstVisibleTab) {
Â  Â  Â  Â  Â  Â  switchToTab(firstVisibleTab);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showAlert('à¸„à¸¸à¸“à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸ªà¹ˆà¸§à¸™à¹ƒà¸”à¹† à¸‚à¸­à¸‡à¸£à¸°à¸šà¸š');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const handleLogin = async () => {
Â  Â  Â  Â  const email = ui.usernameInput.value.trim();
Â  Â  Â  Â  const password = ui.passwordInput.value.trim();
Â  Â  Â  Â  ui.loginError.classList.add('hidden');

Â  Â  Â  Â  if (!email || !password) {
Â  Â  Â  Â  Â  Â  ui.loginError.textContent = 'à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸­à¸µà¹€à¸¡à¸¥à¹à¸¥à¸°à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™';
Â  Â  Â  Â  Â  Â  ui.loginError.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  ui.loginButton.disabled = true;
Â  Â  Â  Â  Â  Â  ui.loginButton.textContent = 'à¸à¸³à¸¥à¸±à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š...';
Â  Â  Â  Â  Â  Â  await signInWithEmailAndPassword(auth, email, password);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Login failed:", error.code);
Â  Â  Â  Â  Â  Â  ui.loginError.textContent = 'à¸­à¸µà¹€à¸¡à¸¥à¸«à¸£à¸·à¸­à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡';
Â  Â  Â  Â  Â  Â  ui.loginError.classList.remove('hidden');
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  ui.loginButton.disabled = false;
Â  Â  Â  Â  Â  Â  ui.loginButton.textContent = 'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š';
Â  Â  Â  Â  Â  Â  ui.passwordInput.value = '';
Â  Â  Â  Â  }
Â  Â  };

Â  Â  const handleLogout = async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await signOut(auth);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Sign out error", error);
Â  Â  Â  Â  Â  Â  showAlert('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š');
Â  Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const initializeAppAndListeners = (user, userRole) => {
Â  Â  Â  Â  if (isAppInitialized) return;

Â  Â  Â  Â  userId = user.uid;
Â  Â  Â  Â  const appDataPath = `artifacts/${appId}/public/data`;
Â  Â  Â  Â  salesCollectionRef = collection(db, `${appDataPath}/sales`);
Â  Â  Â  Â  weighingsCollectionRef = collection(db, `${appDataPath}/weighings`);
Â  Â  Â  Â  truckLoadsCollectionRef = collection(db, `${appDataPath}/truckLoads`);
Â  Â  Â  Â  countersDocRef = doc(db, `${appDataPath}/counters`, 'salesCounter');
Â  Â  Â  Â Â 
Â  Â  Â  Â  applyUserPermissions(userRole);

Â  Â  Â  Â  if (unsubscribeSales) unsubscribeSales();
Â  Â  Â  Â  unsubscribeSales = onSnapshot(query(salesCollectionRef), (snapshot) => {
Â  Â  Â  Â  Â  Â  localSalesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  localSalesData.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
Â  Â  Â  Â  Â  Â  filterAndRenderSalesTable();
Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  renderSummary();
Â  Â  Â  Â  Â  Â  renderScaleSummaries(ui.salesSummaryByScale, ui.salesSummaryTodayTotal, ui.summaryTodayTotalWeight, ui.summaryTodayTotalAmount);
Â  Â  Â  Â  Â  Â  populateReportDateSelector();
Â  Â  Â  Â  Â  Â  populateTruckSummaryDateSelector();
Â  Â  Â  Â  Â  Â  calculateTruckSummary();
Â  Â  Â  Â  Â  Â  populateSellerDatalist(ui.selectedReceiptScale.value);
Â  Â  Â  Â  Â  Â  renderActivityTab();
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (unsubscribeAllWeighings) unsubscribeAllWeighings();
Â  Â  Â  Â  unsubscribeAllWeighings = onSnapshot(query(weighingsCollectionRef), (snapshot) => {
Â  Â  Â  Â  Â  Â  localWeighingData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  renderWeighingHistory();
Â  Â  Â  Â  Â  Â  populateSellerDatalist(ui.selectedReceiptScale.value);
Â  Â  Â  Â  });

Â  Â  Â  Â  if (unsubscribeTruckLoads) unsubscribeTruckLoads();
Â  Â  Â  Â  unsubscribeTruckLoads = onSnapshot(query(truckLoadsCollectionRef), (snapshot) => {
Â  Â  Â  Â  Â  Â  localTruckLoads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  calculateTruckSummary();
Â  Â  Â  Â  Â  Â  renderActivityTab();
Â  Â  Â  Â  });

Â  Â  Â  Â  setupWeighingListeners();
Â  Â  Â  Â  isAppInitialized = true;
Â  Â  }
Â  Â Â 
Â  Â  const cleanupListeners = () => {
Â  Â  Â  Â  if (unsubscribeSales) unsubscribeSales();
Â  Â  Â  Â  if (unsubscribeAllWeighings) unsubscribeAllWeighings();
Â  Â  Â  Â  if (unsubscribeTruckLoads) unsubscribeTruckLoads();
Â  Â  Â  Â  Object.keys(unsubscribeWeighings).forEach(k => unsubscribeWeighings[k]());
Â  Â  Â  Â  isAppInitialized = false;
Â  Â  Â  Â  localSalesData = [];
Â  Â  Â  Â  localWeighingData = [];
Â  Â  Â  Â  localTruckLoads = [];
Â  Â  }
Â  Â Â 
Â  Â  function printBatchDetails(salesInBatch, title) {
Â  Â  Â  Â  if (!salesInBatch || salesInBatch.length === 0) {
Â  Â  Â  Â  Â  Â  showAlert('à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸´à¸¡à¸à¹Œ');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const totalWeight = salesInBatch.reduce((sum, sale) => sum + sale.weight, 0);

Â  Â  Â  Â  const tableRows = salesInBatch.map((sale) => `
Â  Â  Â  Â  Â  Â  <tr class="border-b">
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-center">${sale.dailyQueueNumber || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2">${sale.seller}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right">${sale.weight.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `).join('');

Â  Â  Â  Â  const reportHTML = `
Â  Â  Â  Â  Â  Â  <div class="p-8 bg-white text-black">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold">${title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm border-collapse border border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-stone-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 15%;">à¸„à¸´à¸§</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 55%;">à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-black" style="width: 30%;">à¸™à¹‰à¸³à¸«à¸™à¸±à¸ (à¸à¸.)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${tableRows}</tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tfoot class="font-bold bg-stone-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <tr class="border-t-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="px-2 py-2 text-right" colspan="2">à¸£à¸§à¸¡à¸™à¹‰à¸³à¸«à¸™à¸±à¸</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td class="px-2 py-2 text-right">${totalWeight.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tfoot>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  ui.printArea.innerHTML = reportHTML;
Â  Â  Â  Â  window.print();
Â  Â  }

Â  Â  function exportBatchDetailsToExcel(salesInBatch, title) {
Â  Â  Â  Â  if (!salesInBatch || salesInBatch.length === 0) {
Â  Â  Â  Â  Â  Â  showAlert('à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸š Export');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const headers = ['à¸„à¸´à¸§', 'à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢', 'à¸™à¹‰à¸³à¸«à¸™à¸±à¸ (à¸à¸.)'];
Â  Â  Â  Â  const exportData = [headers];
Â  Â  Â  Â Â 
Â  Â  Â  Â  salesInBatch.forEach(sale => {
Â  Â  Â  Â  Â  Â  exportData.push([
Â  Â  Â  Â  Â  Â  Â  Â  sale.dailyQueueNumber || '',
Â  Â  Â  Â  Â  Â  Â  Â  sale.seller,
Â  Â  Â  Â  Â  Â  Â  Â  sale.weight
Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  });

Â  Â  Â  Â  const ws = XLSX.utils.aoa_to_sheet(exportData);
Â  Â  Â  Â  ws['!cols'] = [{ wch: 10 }, { wch: 40 }, { wch: 20 }];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  for (let i = 1; i < exportData.length; i++) {
Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ c: 2, r: i });
Â  Â  Â  Â  Â  Â  if (ws[cellRef]) {
Â  Â  Â  Â  Â  Â  Â  Â  ws[cellRef].t = 'n';
Â  Â  Â  Â  Â  Â  Â  Â  ws[cellRef].z = '#,##0.00';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
Â  Â  Â  Â Â 
Â  Â  Â  Â  const safeTitle = title.replace(/[^a-z0-9à¸-à¹™]/gi, '_').toLowerCase();
Â  Â  Â  Â  XLSX.writeFile(wb, `à¸£à¸²à¸¢à¸‡à¸²à¸™_${safeTitle}.xlsx`);
Â  Â  }
Â  Â Â 
Â  Â  function getUTCDateKey(date) {
Â  Â  Â  Â  if (!date) return null;
Â  Â  Â  Â  const d = (date.toDate) ? date.toDate() : date;
Â  Â  Â  Â  const year = d.getFullYear();
Â  Â  Â  Â  const month = String(d.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  const day = String(d.getDate()).padStart(2, '0');
Â  Â  Â  Â  return `${year}-${month}-${day}`;
Â  Â  }
Â  Â Â 
Â  Â  async function handleSaveTruckLoad(event) {
Â  Â  Â  Â  const scaleId = event.target.dataset.scale;
Â  Â  Â  Â  const weightToSave = parseFloat(event.target.dataset.weight);
Â  Â  Â  Â  if (!scaleId || isNaN(weightToSave) || weightToSave <= 0) {
Â  Â  Â  Â  Â  Â  showAlert('à¹„à¸¡à¹ˆà¸¡à¸µà¸™à¹‰à¸³à¸«à¸™à¸±à¸à¹ƒà¸«à¹‰à¸šà¸±à¸™à¸—à¸¶à¸ (à¸¢à¸­à¸”à¸•à¹‰à¸­à¸‡à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 0)');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const selectedDateStr = ui.truckSummaryDate.value;
Â  Â  Â  Â  if (!selectedDateStr) {
Â  Â  Â  Â  Â  Â  showAlert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¸à¹ˆà¸­à¸™à¸šà¸±à¸™à¸—à¸¶à¸');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const modalContentHTML = `
Â  Â  Â  Â  Â  Â  <p class="text-sm text-stone-500 mb-4 text-left">
Â  Â  Â  Â  Â  Â  Â  Â  à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸£à¸–à¸ªà¸³à¸«à¸£à¸±à¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸ <strong class="text-stone-800">${weightToSave.toFixed(2)} à¸à¸.</strong> (à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId})
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  <input type="text" id="modal-vehicle-reg-input" class="w-full p-3 border border-stone-300 rounded-lg text-center text-xl" placeholder="à¹€à¸Šà¹ˆà¸™ à¸šà¸ 1234 à¸Šà¸±à¸¢à¸ à¸¹à¸¡à¸´">
Â  Â  Â  Â  Â  Â  <p id="save-load-error" class="text-sm text-red-600 text-center hidden mt-2"></p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  showModal(`à¸£à¸°à¸šà¸¸à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸£à¸–`, modalContentHTML, [{
Â  Â  Â  Â  Â  Â  text: 'à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸',
Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700',
Â  Â  Â  Â  Â  Â  onClick: async () => {
Â  Â  Â  Â  Â  Â  Â  Â  const vehicleRegInput = document.getElementById('modal-vehicle-reg-input');
Â  Â  Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('save-load-error');
Â  Â  Â  Â  Â  Â  Â  Â  const vehicleRegistration = vehicleRegInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (!vehicleRegistration) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸£à¸–';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(truckLoadsCollectionRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scaleId: scaleId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weight: weightToSave,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: selectedDateStr,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: new Date(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId: userId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vehicleRegistration: vehicleRegistration
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸‚à¸¶à¹‰à¸™à¸£à¸–à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error saving truck load:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = `à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, {
Â  Â  Â  Â  Â  Â  text: 'à¸¢à¸à¹€à¸¥à¸´à¸',
Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto mt-2 sm:mt-0 inline-flex justify-center rounded-md border border-stone-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-stone-700 hover:bg-stone-50'
Â  Â  Â  Â  }]);
Â  Â  }
Â  Â Â 
Â  Â  function handleViewLoadBatchDetails(loadId) {
Â  Â  Â  Â  if (!loadId) return;
Â  Â  Â  Â  const currentLoad = localTruckLoads.find(l => l.id === loadId);
Â  Â  Â  Â  if (!currentLoad) {
Â  Â  Â  Â  Â  Â  showAlert('à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¸¶à¹‰à¸™à¸£à¸–');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const endTime = currentLoad.timestamp.toDate();
Â  Â  Â  Â  const scaleId = currentLoad.scaleId;
Â  Â  Â  Â  const dateStr = currentLoad.date;
Â  Â  Â  Â  const previousLoad = localTruckLoads
Â  Â  Â  Â  Â  Â  .filter(l => l.id !== loadId && l.scaleId === scaleId && l.date === dateStr && l.timestamp.toDate() < endTime)
Â  Â  Â  Â  Â  Â  .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate())[0];
Â  Â  Â  Â  let startTime;
Â  Â  Â  Â  if (previousLoad) {
Â  Â  Â  Â  Â  Â  startTime = previousLoad.timestamp.toDate();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const dateParts = dateStr.split('-');
Â  Â  Â  Â  Â  Â  startTime = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
Â  Â  Â  Â  }
Â  Â  Â  Â  const salesInBatch = localSalesData.filter(sale => {
Â  Â  Â  Â  Â  Â  const saleTime = sale.timestamp.toDate();
Â  Â  Â  Â  Â  Â  return sale.scaleNumber == scaleId &&
Â  Â  Â  Â  Â  Â  Â  Â  saleTime <= endTime &&
Â  Â  Â  Â  Â  Â  Â  Â  saleTime > startTime;
Â  Â  Â  Â  }).sort((a, b) => (a.dailyQueueNumber || 0) - (b.dailyQueueNumber || 0));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (salesInBatch.length === 0) {
Â  Â  Â  Â  Â  Â  showAlert(`à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸³à¸«à¸£à¸±à¸šà¸¥à¹‡à¸­à¸•à¸™à¸µà¹‰`);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const formattedTime = endTime.toLocaleTimeString('th-TH');
Â  Â  Â  Â  let modalTitle = `à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹ƒà¸™à¸¥à¹‡à¸­à¸• (à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId} - ${formattedTime})`;

Â  Â  Â  Â  let modalContentHTML = `<div class="text-left text-sm max-h-80 overflow-y-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="sticky top-0 bg-stone-100"><tr><th class="p-2">à¸„à¸´à¸§</th><th class="p-2 text-left">à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢</th><th class="p-2 text-right">à¸™à¹‰à¸³à¸«à¸™à¸±à¸ (à¸à¸.)</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>`;
Â  Â  Â  Â  salesInBatch.forEach(sale => {
Â  Â  Â  Â  Â  Â  modalContentHTML += `<tr class="border-b"><td class="p-2 text-center">${sale.dailyQueueNumber || '-'}</td><td class="p-2">${sale.seller}</td><td class="p-2 text-right">${sale.weight.toFixed(2)}</td></tr>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  const totalWeight = salesInBatch.reduce((sum, sale) => sum + sale.weight, 0);
Â  Â  Â  Â  modalContentHTML += `</tbody><tfoot><tr class="font-bold border-t-2"><td class="p-2" colspan="2">à¸£à¸§à¸¡</td><td class="p-2 text-right">${totalWeight.toFixed(2)}</td></tr></tfoot></table></div>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const modalButtons = [
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  text: 'ğŸ–¨ï¸ à¸à¸´à¸¡à¸à¹Œà¸£à¸²à¸¢à¸‡à¸²à¸™',
Â  Â  Â  Â  Â  Â  Â  Â  classes: 'w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-sky-600 text-base font-medium text-white hover:bg-sky-700',
Â  Â  Â  Â  Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  printBatchDetails(salesInBatch, modalTitle);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  text: 'ğŸ“„ Export to Excel',
Â  Â  Â  Â  Â  Â  Â  Â  classes: 'w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700',
Â  Â  Â  Â  Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exportBatchDetailsToExcel(salesInBatch, modalTitle);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  text: 'à¸›à¸´à¸”',
Â  Â  Â  Â  Â  Â  Â  Â  classes: 'mt-2 w-full inline-flex justify-center rounded-md border border-stone-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-stone-700 hover:bg-stone-50 sm:mt-0'
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  ];

Â  Â  Â  Â  showModal(modalTitle, modalContentHTML, modalButtons);
Â  Â  }
Â  Â Â 
Â  Â  async function handleTruckLoadHistoryClick(e) {
Â  Â  Â  Â  const target = e.target.closest('button');
Â  Â  Â  Â  if (!target) return;
Â  Â  Â  Â  if (target.matches('.view-receipt-list-btn')) {
Â  Â  Â  Â  Â  Â  const loadId = target.dataset.id;
Â  Â  Â  Â  Â  Â  handleViewLoadBatchDetails(loadId);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const loadId = target.dataset.id;
Â  Â  Â  Â  if (!loadId) return;
Â  Â  Â  Â  const loadData = localTruckLoads.find(l => l.id === loadId);
Â  Â  Â  Â  if (!loadData) return;
Â  Â  Â  Â  if (target.classList.contains('delete-load-btn')) {
Â  Â  Â  Â  Â  Â  showConfirm('à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¸µà¹‰?', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(truckLoadsCollectionRef, loadId));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¸š: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else if (target.classList.contains('edit-load-btn')) {
Â  Â  Â  Â  Â  Â  const modalContentHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-stone-500 mb-4 text-left">à¹à¸à¹‰à¹„à¸‚à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¹à¸¥à¸°à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸£à¸–à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${loadData.scaleId}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-stone-600">à¸™à¹‰à¸³à¸«à¸™à¸±à¸ (à¸à¸.)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="modal-edit-load-input" class="w-full p-3 border border-stone-300 rounded-lg text-center text-xl" value="${loadData.weight.toFixed(2)}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-stone-600">à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸£à¸–</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="modal-edit-reg-input" class="w-full p-3 border border-stone-300 rounded-lg text-center text-xl" value="${loadData.vehicleRegistration || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="edit-load-error" class="text-sm text-red-600 text-center hidden mt-2"></p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  showModal(`à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸¶à¹‰à¸™à¸£à¸–`, modalContentHTML, [{
Â  Â  Â  Â  Â  Â  Â  Â  text: 'à¸šà¸±à¸™à¸—à¸¶à¸',
Â  Â  Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700',
Â  Â  Â  Â  Â  Â  Â  Â  onClick: async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inputEl = document.getElementById('modal-edit-load-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const regInputEl = document.getElementById('modal-edit-reg-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('edit-load-error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newWeight = parseFloat(inputEl.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newReg = regInputEl.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(newWeight) || newWeight <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!newReg) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸£à¸–';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(truckLoadsCollectionRef, loadId), { weight: newWeight, vehicleRegistration: newReg });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = `à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, {
Â  Â  Â  Â  Â  Â  Â  Â  text: 'à¸¢à¸à¹€à¸¥à¸´à¸',
Â  Â  Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto mt-2 sm:mt-0 inline-flex justify-center rounded-md border border-stone-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-stone-700 hover:bg-stone-50'
Â  Â  Â  Â  Â  Â  }]);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function renderTruckLoadHistory(loadsForDay, container, showActions = true) {
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const totalLoadedWeight = loadsForDay.reduce((sum, load) => sum + load.weight, 0);

Â  Â  Â  Â  if (showActions) {
Â  Â  Â  Â  Â  Â  ui.truckTotalLoadedWeight.textContent = totalLoadedWeight.toLocaleString('th-TH', {
Â  Â  Â  Â  Â  Â  Â  Â  minimumFractionDigits: 2,
Â  Â  Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (loadsForDay.length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-stone-800 border-b pb-2">à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸‚à¸¶à¹‰à¸™à¸£à¸–</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-stone-500 mt-4 text-center">à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const loadsByScale = loadsForDay.reduce((acc, load) => {
Â  Â  Â  Â  Â  Â  const scale = load.scaleId;
Â  Â  Â  Â  Â  Â  if (!acc[scale]) acc[scale] = [];
Â  Â  Â  Â  Â  Â  acc[scale].push(load);
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});

Â  Â  Â  Â  const formattedDate = new Date(loadsForDay[0].date.replace(/-/g, '/')).toLocaleDateString('th-TH', {
Â  Â  Â  Â  Â  Â  year: 'numeric', month: 'long', day: 'numeric'
Â  Â  Â  Â  });

Â  Â  Â  Â  let historyHtml = `
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-stone-800 border-b pb-2">à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸‚à¸¶à¹‰à¸™à¸£à¸– (${formattedDate})</h3>
Â  Â  Â  Â  Â  Â  Â  Â  ${showActions ? `<button id="print-truck-history-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-sky-700 transition-colors flex items-center gap-2 no-print">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xl">ğŸ–¨ï¸</span> à¸à¸´à¸¡à¸à¹Œà¸›à¸£à¸°à¸§à¸±à¸•à¸´
Â  Â  Â  Â  Â  Â  Â  Â  </button>` : ''}
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  const sortedScales = Object.keys(loadsByScale).sort((a, b) => a - b);
Â  Â  Â  Â  for (const scaleId of sortedScales) {
Â  Â  Â  Â  Â  Â  historyHtml += `<div class="mb-4 bg-stone-50 p-4 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-md text-stone-700">à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <ul class="list-none mt-2 space-y-2 text-stone-600">`;
Â  Â  Â  Â  Â  Â  loadsByScale[scaleId].sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate()).forEach((load, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  historyHtml += `<li class="flex justify-between items-center border-b border-stone-200 py-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ ${index + 1}:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong class="text-stone-900 ml-2">${load.weight.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} à¸à¸.</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="block text-sm text-sky-700 font-semibold">${load.vehicleRegistration || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸—à¸°à¹€à¸šà¸µà¸¢à¸™'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-stone-500">(${load.timestamp.toDate().toLocaleTimeString('th-TH')})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="view-receipt-list-btn text-blue-600 hover:text-blue-800 p-1 rounded-md text-xl no-print" data-id="${load.id}" title="à¸”à¸¹à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹ƒà¸™à¸¥à¹‡à¸­à¸•à¸™à¸µà¹‰">ğŸ“‹</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${showActions ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-load-btn text-blue-600 hover:text-blue-800 p-1 rounded-md text-lg no-print" data-id="${load.id}" title="à¹à¸à¹‰à¹„à¸‚">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-load-btn text-red-600 hover:text-red-800 p-1 rounded-md text-lg no-print" data-id="${load.id}" title="à¸¥à¸š">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </li>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  historyHtml += `</ul></div>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  container.innerHTML = historyHtml;
Â  Â  Â  Â  if(showActions){
Â  Â  Â  Â  Â  Â  document.getElementById('print-truck-history-btn').addEventListener('click', () => printTruckLoadHistory(loadsByScale, formattedDate, totalLoadedWeight));
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function calculateTruckSummary() {
Â  Â  Â  Â  const selectedDateStr = ui.truckSummaryDate.value;
Â  Â  Â  Â  if (!selectedDateStr) {
Â  Â  Â  Â  Â  Â  ui.truckSummaryContainer.innerHTML = '<p class="text-center text-stone-500 md:col-span-2">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¹€à¸¥à¸·à¸­à¸</p>';
Â  Â  Â  Â  Â  Â  ui.truckGrandTotalWeight.textContent = "0.00";
Â  Â  Â  Â  Â  Â  ui.truckTotalLoadedWeight.textContent = "0.00";
Â  Â  Â  Â  Â  Â  ui.truckLoadHistoryContainer.innerHTML = "";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  };
Â  Â  Â  Â  const dateParts = selectedDateStr.split('-');
Â  Â  Â  Â  const reportStart = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
Â  Â  Â  Â  const reportEnd = new Date(reportStart.getTime() + (24 * 60 * 60 * 1000) - 1);
Â  Â  Â  Â  const salesForDay = localSalesData.filter(sale => {
Â  Â  Â  Â  Â  Â  const saleDate = sale.date.toDate();
Â  Â  Â  Â  Â  Â  return saleDate >= reportStart && saleDate <= reportEnd;
Â  Â  Â  Â  });
Â  Â  Â  Â  const loadsForDay = localTruckLoads.filter(load => load.date === selectedDateStr);
Â  Â  Â  Â  const summary = salesForDay.reduce((acc, sale) => {
Â  Â  Â  Â  Â  Â  const scale = sale.scaleNumber || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸';
Â  Â  Â  Â  Â  Â  if (!acc[scale]) {
Â  Â  Â  Â  Â  Â  Â  Â  acc[scale] = { totalSalesWeight: 0, count: 0 };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  acc[scale].totalSalesWeight += sale.weight;
Â  Â  Â  Â  Â  Â  acc[scale].count++;
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});
Â  Â  Â  Â  const loadedSummary = loadsForDay.reduce((acc, load) => {
Â  Â  Â  Â  Â  Â  const scale = load.scaleId;
Â  Â  Â  Â  Â  Â  if (!acc[scale]) {
Â  Â  Â  Â  Â  Â  Â  Â  acc[scale] = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  acc[scale] += load.weight;
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});
Â  Â  Â  Â  Object.keys(summary).forEach(scaleId => {
Â  Â  Â  Â  Â  Â  if (!loadedSummary[scaleId]) loadedSummary[scaleId] = 0;
Â  Â  Â  Â  });
Â  Â  Â  Â  renderTruckSummary(summary, loadedSummary);
Â  Â  Â  Â  renderTruckLoadHistory(loadsForDay, ui.truckLoadHistoryContainer, true);
Â  Â  }
Â  Â Â 
Â  Â  function renderTruckSummary(salesSummary, loadedSummary) {
Â  Â  Â  Â  ui.truckSummaryContainer.innerHTML = '';
Â  Â  Â  Â  let grandTotal = 0;
Â  Â  Â  Â  const allScales = new Set([...Object.keys(salesSummary), ...Object.keys(loadedSummary)]);
Â  Â  Â  Â  const sortedScales = Array.from(allScales).sort((a, b) => {
Â  Â  Â  Â  Â  Â  if (a === 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸') return 1;
Â  Â  Â  Â  Â  Â  if (b === 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸') return -1;
Â  Â  Â  Â  Â  Â  return a - b;
Â  Â  Â  Â  });
Â  Â  Â  Â  if (sortedScales.length === 0) {
Â  Â  Â  Â  Â  Â  ui.truckSummaryContainer.innerHTML = '<p class="text-center text-stone-500 md:col-span-2">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸‚à¸²à¸¢à¹ƒà¸™à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸</p>';
Â  Â  Â  Â  }
Â  Â  Â  Â  for (const scale of sortedScales) {
Â  Â  Â  Â  Â  Â  const salesData = salesSummary[scale] || { totalSalesWeight: 0, count: 0 };
Â  Â  Â  Â  Â  Â  const loadedWeight = loadedSummary[scale] || 0;
Â  Â  Â  Â  Â  Â  const currentWeight = salesData.totalSalesWeight - loadedWeight;
Â  Â  Â  Â  Â  Â  grandTotal += currentWeight;
Â  Â  Â  Â  Â  Â  let colors;
Â  Â  Â  Â  Â  Â  const scaleNum = parseInt(scale);
Â  Â  Â  Â  Â  Â  if (!isNaN(scaleNum) && scaleNum > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  colors = scaleColorPalette[(scaleNum - 1) % scaleColorPalette.length];
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  colors = defaultScaleColor;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  card.className = `${colors.bg} border ${colors.border} p-4 rounded-xl shadow-md flex flex-col`;
Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-bold ${colors.textH}">à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scale}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-4xl font-bold ${colors.textP} mt-2 scale-total-weight">${currentWeight.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} <span class="text-base font-normal">à¸à¸.</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm ${colors.textS} mt-1">à¸ˆà¸²à¸ ${salesData.count} à¸£à¸²à¸¢à¸à¸²à¸£</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button data-scale="${scale}" data-weight="${currentWeight}" class="save-load-btn w-full text-lg mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" ${currentWeight <= 0 ? 'disabled' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸¥à¹‡à¸­à¸•à¸™à¸µà¹‰
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  ui.truckSummaryContainer.appendChild(card);
Â  Â  Â  Â  }
Â  Â  Â  Â  ui.truckGrandTotalWeight.textContent = grandTotal.toLocaleString('th-TH', {
Â  Â  Â  Â  Â  Â  minimumFractionDigits: 2,
Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function switchToTab(targetTabId) {
Â  Â  Â  Â  ui.tabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  ui.tabContents.forEach(content => content.classList.remove('active'));
Â  Â  Â  Â  const targetButton = document.querySelector(`.tab-btn[data-tab="${targetTabId}"]`);
Â  Â  Â  Â  if (targetButton) {
Â  Â  Â  Â  Â  Â  targetButton.classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â  const targetContent = document.getElementById(targetTabId);
Â  Â  Â  Â  if (targetContent) {
Â  Â  Â  Â  Â  Â  targetContent.classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â  if (targetTabId === 'tab-receipt') {
Â  Â  Â  Â  Â  Â  const firstSubTab = ui.receiptSubTabs.querySelector('.receipt-sub-btn');
Â  Â  Â  Â  Â  Â  if (firstSubTab) _switchToSubTab('receipt', firstSubTab.dataset.subtab);
Â  Â  Â  Â  Â  Â  const firstReceiptScaleTab = ui.receiptScaleSubTabs.querySelector('.receipt-scale-sub-btn');
Â  Â  Â  Â  Â  Â  if (firstReceiptScaleTab) firstReceiptScaleTab.click();
Â  Â  Â  Â  } else if (targetTabId === 'tab-weighing-consolidated') {
Â  Â  Â  Â  Â  Â  const firstSubTab = ui.weighingSubTabs.querySelector('.weighing-sub-btn');
Â  Â  Â  Â  Â  Â  if (firstSubTab) _switchToSubTab('weighing', firstSubTab.dataset.subtab);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function showModal(title, message, buttons) {
Â  Â  Â  Â  ui.modalTitle.textContent = title;
Â  Â  Â  Â  ui.modalMessageContainer.innerHTML = message;
Â  Â  Â  Â  ui.modalActions.innerHTML = '';
Â  Â  Â  Â  buttons.forEach(btn => {
Â  Â  Â  Â  Â  Â  const buttonEl = document.createElement('button');
Â  Â  Â  Â  Â  Â  buttonEl.textContent = btn.text;
Â  Â  Â  Â  Â  Â  buttonEl.className = btn.classes;
Â  Â  Â  Â  Â  Â  buttonEl.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const shouldHide = btn.onClick ? btn.onClick() : true;
Â  Â  Â  Â  Â  Â  Â  Â  if (shouldHide !== false) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideModal();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  ui.modalActions.appendChild(buttonEl);
Â  Â  Â  Â  });
Â  Â  Â  Â  ui.modal.classList.remove('hidden');
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  ui.modal.classList.remove('opacity-0');
Â  Â  Â  Â  Â  Â  ui.modal.querySelector('.modal-content').classList.remove('scale-95');
Â  Â  Â  Â  }, 10);
Â  Â  }
Â  Â Â 
Â  Â  function hideModal() {
Â  Â  Â  Â  ui.modal.classList.add('opacity-0');
Â  Â  Â  Â  ui.modal.querySelector('.modal-content').classList.add('scale-95');
Â  Â  Â  Â  setTimeout(() => ui.modal.classList.add('hidden'), 300);
Â  Â  }
Â  Â Â 
Â  Â  function showAlert(message) {
Â  Â  Â  Â  showModal('à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™', `<p class="text-sm text-stone-500">${message}</p>`, [{
Â  Â  Â  Â  Â  Â  text: 'à¸•à¸à¸¥à¸‡',
Â  Â  Â  Â  Â  Â  classes: 'w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-amber-600 text-base font-medium text-white hover:bg-amber-700 sm:w-auto sm:text-sm'
Â  Â  Â  Â  }]);
Â  Â  }
Â  Â Â 
Â  Â  function showConfirm(message, onConfirm) {
Â  Â  Â  Â  showModal('à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£', `<p class="text-sm text-stone-500">${message}</p>`, [{
Â  Â  Â  Â  Â  Â  text: 'à¸¢à¸·à¸™à¸¢à¸±à¸™',
Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700',
Â  Â  Â  Â  Â  Â  onClick: onConfirm
Â  Â  Â  Â  }, {
Â  Â  Â  Â  Â  Â  text: 'à¸¢à¸à¹€à¸¥à¸´à¸',
Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto mt-2 sm:mt-0 inline-flex justify-center rounded-md border border-stone-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-stone-700 hover:bg-stone-50'
Â  Â  Â  Â  }]);
Â  Â  }
Â  Â Â 
Â  Â  function bahttext(number) {
Â  Â  Â  Â  number = Number(number).toFixed(2);
Â  Â  Â  Â  let [integer,
Â  Â  Â  Â  Â  Â  fraction] = number.split('.');
Â  Â  Â  Â  if (parseInt(integer) === 0 && parseInt(fraction) === 0) return 'à¸¨à¸¹à¸™à¸¢à¹Œà¸šà¸²à¸—à¸–à¹‰à¸§à¸™';
Â  Â  Â  Â  const t = ['', 'à¸«à¸™à¸¶à¹ˆà¸‡', 'à¸ªà¸­à¸‡', 'à¸ªà¸²à¸¡', 'à¸ªà¸µà¹ˆ', 'à¸«à¹‰à¸²', 'à¸«à¸', 'à¹€à¸ˆà¹‡à¸”', 'à¹à¸›à¸”', 'à¹€à¸à¹‰à¸²'];
Â  Â  Â  Â  const r = ['', 'à¸ªà¸´à¸š', 'à¸£à¹‰à¸­à¸¢', 'à¸à¸±à¸™', 'à¸«à¸¡à¸·à¹ˆà¸™', 'à¹à¸ªà¸™', 'à¸¥à¹‰à¸²à¸™'];
Â  Â  Â  Â  const convert = (n) => {
Â  Â  Â  Â  Â  Â  let s = '';
Â  Â  Â  Â  Â  Â  let l = n.length;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < l; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  let d = parseInt(n.charAt(i));
Â  Â  Â  Â  Â  Â  Â  Â  let p = l - i - 1;
Â  Â  Â  Â  Â  Â  Â  Â  if (d > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (p === 1 && d === 2) s += 'à¸¢à¸µà¹ˆ';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (p === 1 && d === 1) s += '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (p === 0 && d === 1 && s.length > 0 && n.length > 1 && n.charAt(n.length - 2) !== '0') s += 'à¹€à¸­à¹‡à¸”';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else s += t[d];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s += r[p];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return s;
Â  Â  Â  Â  };
Â  Â  Â  Â  let intText = convert(integer);
Â  Â  Â  Â  let fracText = convert(fraction);
Â  Â  Â  Â  if (intText) intText += 'à¸šà¸²à¸—';
Â  Â  Â  Â  if (fracText) fracText += 'à¸ªà¸•à¸²à¸‡à¸„à¹Œ';
Â  Â  Â  Â  if (!fracText && intText) fracText = 'à¸–à¹‰à¸§à¸™';
Â  Â  Â  Â  return intText + fracText;
Â  Â  }
Â  Â Â 
Â  Â  function calculateTotals() {
Â  Â  Â  Â  let totalWeight = 0;
Â  Â  Â  Â  const weightInputs = ui.weightInputsContainer.querySelectorAll('.weight-input');
Â  Â  Â  Â  weightInputs.forEach(input => {
Â  Â  Â  Â  Â  Â  totalWeight += parseFloat(input.value) || 0;
Â  Â  Â  Â  });
Â  Â  Â  Â  const pricePerKg = parseFloat(ui.pricePerKgInput.value) || 0;
Â  Â  Â  Â  const totalAmount = totalWeight * pricePerKg;
Â  Â  Â  Â  const roundedTotal = Math.floor(totalAmount);

Â  Â  Â  Â  ui.totalWeightEl.textContent = totalWeight.toFixed(2);
Â  Â  Â  Â  ui.totalAmountEl.textContent = totalAmount.toLocaleString('th-TH', {
Â  Â  Â  Â  Â  Â  minimumFractionDigits: 2,
Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  });
Â  Â  Â  Â  ui.totalAmountTextEl.textContent = bahttext(roundedTotal);
Â  Â  }
Â  Â Â 
Â  Â  function renderTable(dataToRender) {
Â  Â  Â  Â  ui.salesTableBody.innerHTML = '';
Â  Â  Â  Â  if (dataToRender.length === 0) {
Â  Â  Â  Â  Â  Â  ui.salesTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-stone-400">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</td></tr>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  dataToRender.forEach((sale) => {
Â  Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  Â  row.className = 'bg-white border-b hover:bg-stone-50';
Â  Â  Â  Â  Â  Â  const saleDate = sale.date instanceof Date ? sale.date : sale.date.toDate();
Â  Â  Â  Â  Â  Â  const printCount = sale.printCount || 0;
Â  Â  Â  Â  Â  Â  let printStatusHtml = '';
Â  Â  Â  Â  Â  Â  if (printCount > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  printStatusHtml = `<span class="text-green-600 font-semibold">âœ“ à¸à¸´à¸¡à¸à¹Œà¹à¸¥à¹‰à¸§ (${printCount} à¸„à¸£à¸±à¹‰à¸‡)</span>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  printStatusHtml = `<span class="text-stone-500">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸´à¸¡à¸à¹Œ</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 text-center font-medium text-stone-700">${sale.dailyQueueNumber || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4">${saleDate.toLocaleDateString('th-TH')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 font-medium text-stone-900 whitespace-nowrap">${sale.seller}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 text-right">${sale.weight.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 text-right">${sale.price.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 text-right font-bold text-amber-600">${sale.total.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-4 py-4 text-center">${printStatusHtml}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="reprint-btn text-gray-500 hover:text-gray-800 p-2 rounded-md hover:bg-gray-100" data-id="${sale.id}" title="à¸à¸´à¸¡à¸à¹Œà¸‹à¹‰à¸³">ğŸ–¨ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-btn text-blue-600 hover:text-blue-800 p-2 rounded-md hover:bg-blue-100" data-id="${sale.id}" title="à¹à¸à¹‰à¹„à¸‚">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-btn text-red-600 hover:text-red-800 p-2 rounded-md hover:bg-red-100" data-id="${sale.id}" title="à¸¥à¸š">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  ui.salesTableBody.appendChild(row);
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function renderSummary() {
Â  Â  Â  Â  if (!localSalesData || localSalesData.length === 0) {
Â  Â  Â  Â  Â  Â  ui.summaryTotalSellers.textContent = '0';
Â  Â  Â  Â  Â  Â  ui.summaryTotalWeight.textContent = '0.00';
Â  Â  Â  Â  Â  Â  ui.summaryTotalPrice.textContent = '0.00';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const totalSellers = new Set(localSalesData.map(s => s.seller)).size;
Â  Â  Â  Â  const totalWeight = localSalesData.reduce((acc, sale) => acc + sale.weight, 0);
Â  Â  Â  Â  const totalPrice = localSalesData.reduce((acc, sale) => acc + sale.total, 0);
Â  Â  Â  Â  ui.summaryTotalSellers.textContent = totalSellers.toLocaleString('th-TH');
Â  Â  Â  Â  ui.summaryTotalWeight.textContent = totalWeight.toLocaleString('th-TH', {
Â  Â  Â  Â  Â  Â  minimumFractionDigits: 2,
Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  });
Â  Â  Â  Â  ui.summaryTotalPrice.textContent = totalPrice.toLocaleString('th-TH', {
Â  Â  Â  Â  Â  Â  minimumFractionDigits: 2,
Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function renderDashboard() {
Â  Â  Â  Â  renderDailyStatsChart();
Â  Â  }
Â  Â Â 
Â  Â  function renderDailyStatsChart() {
Â  Â  Â  Â  const statsByDay = localSalesData.reduce((acc, sale) => {
Â  Â  Â  Â  Â  Â  const day = sale.date.toDate().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  if (!acc[day]) {
Â  Â  Â  Â  Â  Â  Â  Â  acc[day] = { totalWeight: 0, totalValue: 0 };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  acc[day].totalWeight += sale.weight;
Â  Â  Â  Â  Â  Â  acc[day].totalValue += sale.total;
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});
Â  Â  Â  Â  const sortedDays = Object.keys(statsByDay).sort((a, b) => new Date(a) - new Date(b));
Â  Â  Â  Â  const labels = sortedDays.map(day => new Date(day).toLocaleDateString('th-TH', {
Â  Â  Â  Â  Â  Â  year: '2-digit', month: 'short', day: 'numeric'
Â  Â  Â  Â  }));
Â  Â  Â  Â  const weightData = sortedDays.map(day => statsByDay[day].totalWeight);
Â  Â  Â  Â  const priceData = sortedDays.map(day => {
Â  Â  Â  Â  Â  Â  const stats = statsByDay[day];
Â  Â  Â  Â  Â  Â  return stats.totalWeight > 0 ? stats.totalValue / stats.totalWeight : 0;
Â  Â  Â  Â  });
Â  Â  Â  Â  if (dailyStatsChart) {
Â  Â  Â  Â  Â  Â  dailyStatsChart.destroy();
Â  Â  Â  Â  }
Â  Â  Â  Â  const canvas = document.getElementById('daily-stats-chart');
Â  Â  Â  Â  if (canvas && labels.length > 0) {
Â  Â  Â  Â  Â  Â  dailyStatsChart = new Chart(canvas.getContext('2d'), {
Â  Â  Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'à¸›à¸£à¸´à¸¡à¸²à¸“à¸¢à¸²à¸‡ (à¸à¸.)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: weightData,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(217, 119, 6, 0.6)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: 'rgb(217, 119, 6)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yAxisID: 'yWeight',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'à¸£à¸²à¸„à¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ (à¸šà¸²à¸—)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: priceData,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fill: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(54, 162, 235, 1)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: 'rgba(54, 162, 235, 1)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yAxisID: 'yPrice',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  interaction: { mode: 'index', intersect: false },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: { ticks: { font: { family: "'Sarabun', sans-serif" } } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yWeight: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'linear',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'left',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: { display: true, text: 'à¸›à¸£à¸´à¸¡à¸²à¸“ (à¸à¸.)', font: { family: "'Sarabun', sans-serif", size: 14 } }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yPrice: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'linear',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'right',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: { display: true, text: 'à¸£à¸²à¸„à¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ (à¸šà¸²à¸—)', font: { family: "'Sarabun', sans-serif", size: 14 } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { drawOnChartArea: false }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: { position: 'top', labels: { font: { family: "'Sarabun', sans-serif" } } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleFont: { family: "'Sarabun', sans-serif" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bodyFont: { family: "'Sarabun', sans-serif" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  footerFont: { family: "'Sarabun', sans-serif" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function renderWeighingHistory() {
Â  Â  Â  Â  const historyBody = ui.weighingHistoryBody;
Â  Â  Â  Â  if (!historyBody) return;
Â  Â  Â  Â  const salesWeightByDay = localSalesData.reduce((acc, sale) => {
Â  Â  Â  Â  Â  Â  const day = sale.date.toDate().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  if (!acc[day]) acc[day] = 0;
Â  Â  Â  Â  Â  Â  acc[day] += sale.weight;
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});
Â  Â  Â  Â  const statsByDay = localWeighingData.reduce((acc, entry) => {
Â  Â  Â  Â  Â  Â  const day = entry.timestamp.toDate().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  if (!acc[day]) acc[day] = { totalBags: 0, recordCount: 0 };
Â  Â  Â  Â  Â  Â  acc[day].totalBags += entry.bags;
Â  Â  Â  Â  Â  Â  acc[day].recordCount++;
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});
Â  Â  Â  Â  const sortedDays = Object.keys(statsByDay).sort((a, b) => new Date(b) - new Date(a));
Â  Â  Â  Â  historyBody.innerHTML = '';
Â  Â  Â  Â  if (sortedDays.length === 0) {
Â  Â  Â  Â  Â  Â  historyBody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-stone-400">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡</td></tr>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  sortedDays.forEach(day => {
Â  Â  Â  Â  Â  Â  const stats = statsByDay[day];
Â  Â  Â  Â  Â  Â  const currentDate = new Date(day);
Â  Â  Â  Â  Â  Â  currentDate.setDate(currentDate.getDate() + 1);
Â  Â  Â  Â  Â  Â  const nextDayKey = currentDate.toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  const nextDayWeight = salesWeightByDay[nextDayKey] || 0;
Â  Â  Â  Â  Â  Â  const averageWeight = (nextDayWeight > 0 && stats.totalBags > 0) ? (nextDayWeight / stats.totalBags) : 0;
Â  Â  Â  Â  Â  Â  const formattedDate = new Date(day).toLocaleDateString('th-TH', {
Â  Â  Â  Â  Â  Â  Â  Â  year: 'numeric', month: 'long', day: 'numeric'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  Â  row.className = 'bg-white border-b hover:bg-stone-50';
Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 font-medium text-stone-900">${formattedDate}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 text-center">${stats.recordCount.toLocaleString('th-TH')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 text-center font-bold text-amber-700">${stats.totalBags.toLocaleString('th-TH')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-6 py-4 text-center font-semibold text-blue-600">${averageWeight.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  historyBody.appendChild(row);
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function renderActivityTab(){
Â  Â  Â  Â  renderScaleSummaries(ui.activitySalesSummaryByScale, ui.activitySalesSummaryTodayTotal, ui.activitySummaryTodayTotalWeight, ui.activitySummaryTodayTotalAmount);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const allLoadDates = [...new Set(localTruckLoads.map(load => load.date))];
Â  Â  Â  Â  if (allLoadDates.length > 0) {
Â  Â  Â  Â  Â  Â  Â const mostRecentDate = allLoadDates.sort().pop();
Â  Â  Â  Â  Â  Â  Â const loadsForDay = localTruckLoads.filter(load => load.date === mostRecentDate);
Â  Â  Â  Â  Â  Â  Â renderTruckLoadHistory(loadsForDay, ui.activityTruckLoadHistoryContainer, false);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  ui.activityTruckLoadHistoryContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-stone-800 border-b pb-2">à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸‚à¸¶à¹‰à¸™à¸£à¸– (à¸¥à¹ˆà¸²à¸ªà¸¸à¸”)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-stone-500 mt-4 text-center">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸‚à¸¶à¹‰à¸™à¸£à¸–</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function createPrintableReceipt(sale) {
Â  Â  Â  Â  const saleDate = sale.date instanceof Date ? sale.date : sale.date.toDate();
Â  Â  Â  Â  const roundedTotal = Math.floor(sale.total);

Â  Â  Â  Â  const generateSingleReceiptHTML = (title, isCopy = false) => `
Â  Â  Â  Â  Â  Â  <div style="width: 50%; padding: 0.7rem; font-size: 11px; border: 2px dashed #9ca3af; height: 11cm; display: flex; flex-direction: column; box-sizing: border-box;">
Â  Â  Â  Â  Â  Â  Â  Â  ${isCopy ? '<div class="watermark">à¸ªà¸³à¹€à¸™à¸²</div>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-bottom: 0.5rem;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="font-size: 1rem; font-weight: 700;">${title}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="font-size: 0.875rem; font-weight: 600; margin-top: 0.25rem;">à¸ªà¸«à¸à¸£à¸“à¹Œà¸à¸­à¸‡à¸—à¸¸à¸™à¸ªà¸§à¸™à¸¢à¸²à¸‡à¸à¸²à¸£à¸²à¹€à¸à¸©à¸•à¸£à¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ à¸ˆà¸³à¸à¸±à¸”</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 0.75rem;">15/1 à¸¡.6 à¸•.à¸«à¸™à¸­à¸‡à¹‚à¸à¸™à¸‡à¸²à¸¡ à¸­.à¹€à¸à¸©à¸•à¸£à¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ à¸ˆ.à¸Šà¸±à¸¢à¸ à¸¹à¸¡à¸´</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="border-top: 1px dotted #4a5568; border-bottom: 1px dotted #4a5568; padding: 0.25rem 0; margin-bottom: 0.5rem;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between;"><span>à¹€à¸¥à¸‚à¸—à¸µà¹ˆ:</span><span>${sale.receiptId || 'N/A'}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; margin-top: 2px;"><span>à¸§à¸±à¸™à¸—à¸µà¹ˆ:</span><span>${saleDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; margin-top: 2px;"><span>à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ:</span><span>${sale.scaleNumber || '-'}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 0.5rem;"><strong>à¸œà¸¹à¹‰à¸‚à¸²à¸¢:</strong> <span style="font-size: 16px; font-weight: bold;">${sale.seller}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <table style="width: 100%; margin: 4px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead style="border-top: 1px dotted #4a5568; border-bottom: 1px dotted #4a5568;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th style="padding: 4px 0; text-align: left;">à¸£à¸²à¸¢à¸à¸²à¸£</th><th style="padding: 4px 0; text-align: right;">à¸¢à¸­à¸”à¸£à¸§à¸¡ (à¸šà¸²à¸—)</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody style="border-bottom: 1px dotted #4a5568;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 6px 0; vertical-align: top;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  à¸„à¹ˆà¸²à¸¢à¸²à¸‡à¸à¹‰à¸­à¸™à¸–à¹‰à¸§à¸¢ ${sale.receiptType ? `<strong>(${sale.receiptType})</strong>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="display: block; font-size: 10px;">à¸™à¹‰à¸³à¸«à¸™à¸±à¸: ${sale.weight.toFixed(2)} à¸à¸. @ ${sale.price.toFixed(2)} à¸šà¸²à¸—/à¸à¸. (${sale.bagsCount || '-'} à¸–à¸¸à¸‡)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 6px 0; vertical-align: top; text-align: right;">${roundedTotal.toLocaleString('th-TH')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tfoot>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="font-weight: bold;"><td style="padding: 6px 0; font-size: 14px;">à¸£à¸§à¸¡à¹€à¸›à¹‡à¸™à¹€à¸‡à¸´à¸™</td><td style="text-align: right; font-size: 18px;">${roundedTotal.toLocaleString('th-TH')}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tfoot>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex-grow: 1;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 10px;">à¸à¸´à¸¡à¸à¹Œà¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ: ${sale.printCount || 1}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-top: 1rem;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><p style="padding-bottom: 4px;">........................................</p><p>(à¸œà¸¹à¹‰à¸ˆà¹ˆà¸²à¸¢à¹€à¸‡à¸´à¸™)</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  ui.printArea.innerHTML = `<div style="display: flex; width: 100%;">${generateSingleReceiptHTML('à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸£à¸±à¸šà¹€à¸‡à¸´à¸™ (à¸•à¹‰à¸™à¸‰à¸šà¸±à¸š)')}${generateSingleReceiptHTML('à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸£à¸±à¸šà¹€à¸‡à¸´à¸™ (à¸ªà¸³à¹€à¸™à¸²)', true)}</div>`;
Â  Â  Â  Â  window.print();
Â  Â  }

Â  Â  function createDailySummaryReport() {
Â  Â  Â  Â  const reportDateStr = ui.reportDateSelect.value;
Â  Â  Â  Â  if (!reportDateStr) {
Â  Â  Â  Â  Â  Â  return showAlert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸—à¸³à¸£à¸²à¸¢à¸‡à¸²à¸™');
Â  Â  Â  Â  }
Â  Â  Â  Â  const dateParts = reportDateStr.split('-');
Â  Â  Â  Â  const reportDate = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
Â  Â  Â  Â  const formattedDate = reportDate.toLocaleDateString('th-TH', {
Â  Â  Â  Â  Â  Â  year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC'
Â  Â  Â  Â  });
Â  Â  Â  Â  const reportStart = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
Â  Â  Â  Â  const reportEnd = new Date(reportStart.getTime() + (24 * 60 * 60 * 1000) - 1);
Â  Â  Â  Â  const salesForDay = localSalesData.filter(sale => {
Â  Â  Â  Â  Â  Â  const saleDate = sale.date.toDate();
Â  Â  Â  Â  Â  Â  return saleDate >= reportStart && saleDate <= reportEnd;
Â  Â  Â  Â  }).sort((a, b) => (a.dailyQueueNumber || 0) - (b.dailyQueueNumber || 0));
Â  Â  Â  Â  if (salesForDay.length === 0) {
Â  Â  Â  Â  Â  Â  return showAlert(`à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸‚à¸²à¸¢à¹ƒà¸™à¸§à¸±à¸™à¸—à¸µà¹ˆ ${formattedDate}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  const totalWeight = salesForDay.reduce((sum, sale) => sum + sale.weight, 0);
Â  Â  Â  Â  const totalAmount = salesForDay.reduce((sum, sale) => sum + sale.total, 0);
Â  Â  Â  Â  const tableRows = salesForDay.map((sale, index) => `
Â  Â  Â  Â  Â  Â  <tr class="border-b">
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-center">${sale.dailyQueueNumber || index + 1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2">${sale.seller}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right">${sale.weight.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right">${sale.price.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right">${sale.total.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-center">${sale.scaleNumber || ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 border-l"></td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  const reportHTML = `
Â  Â  Â  Â  Â  Â  <div class="p-8 bg-white text-black">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold">à¸£à¸²à¸¢à¸‡à¸²à¸™à¸à¸²à¸£à¸Šà¸±à¹ˆà¸‡à¸¢à¸²à¸‡à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™à¸—à¸µà¹ˆ ${formattedDate}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm border-collapse border border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-stone-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 5%;">à¸„à¸´à¸§</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 30%;">à¸Šà¸·à¹ˆà¸­</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 15%;">à¸™à¹‰à¸³à¸«à¸™à¸±à¸</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 15%;">à¸£à¸²à¸„à¸²</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 15%;">à¸¢à¸­à¸”à¸£à¸§à¸¡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 5%;">à¸•à¸²à¸Šà¸±à¹ˆà¸‡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2" style="width: 15%;">à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${tableRows}</tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tfoot class="font-bold bg-stone-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-t-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right" colspan="2">à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸ªà¸´à¹‰à¸™</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right">${totalWeight.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right">${totalAmount.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2" colspan="2"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tfoot>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  ui.printArea.innerHTML = reportHTML;
Â  Â  Â  Â  window.print();
Â  Â  }
Â  Â Â 
    // ### MODIFIED ###: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ clearForm à¹ƒà¸«à¹‰à¸„à¸‡à¸ªà¸–à¸²à¸™à¸°à¸¥à¹‡à¸­à¸„à¸‚à¸­à¸‡à¸£à¸²à¸„à¸²à¹„à¸§à¹‰
Â  Â  function clearForm() {
Â  Â  Â  Â  ui.sellerNameInput.value = '';
Â  Â  Â  Â  ui.receiptBagsCount.value = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const typeRadios = document.querySelectorAll('.receipt-type-radio');
Â  Â  Â  Â  typeRadios.forEach(radio => radio.checked = false);

Â  Â  Â  Â  ui.weightInputsContainer.querySelectorAll('.weight-input').forEach(input => input.value = '');

Â  Â  Â  Â  const currentScaleId = ui.selectedReceiptScale.value;
        // à¸«à¸²à¸à¸£à¸²à¸„à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸–à¸¹à¸à¸¥à¹‡à¸­à¸„à¸­à¸¢à¸¹à¹ˆ à¹ƒà¸«à¹‰à¸¥à¹‰à¸²à¸‡à¸„à¹ˆà¸²à¹ƒà¸™à¸Šà¹ˆà¸­à¸‡à¸£à¸²à¸„à¸²
Â  Â  Â  Â  if (currentScaleId && lockStates[currentScaleId] && !lockStates[currentScaleId].price) {
Â  Â  Â  Â  Â  Â  Â ui.pricePerKgInput.value = '';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  editingId = null;
Â  Â  Â  Â  ui.saveButton.textContent = 'à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥';
Â  Â  Â  Â  ui.cancelEditButton.classList.add('hidden');
Â  Â  Â  Â  calculateTotals();
Â  Â  }
Â  Â Â 
    // ### ADDED ###: à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸­à¸±à¸›à¹€à¸”à¸• UI à¸‚à¸­à¸‡à¸›à¸¸à¹ˆà¸¡à¸¥à¹‡à¸­à¸„à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸‚à¸­à¸‡à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸
Â  Â  function applyLockState(scaleId) {
Â  Â  Â  Â  if (!scaleId || !lockStates[scaleId]) return;

Â  Â  Â  Â  const state = lockStates[scaleId];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Price Lock UI
Â  Â  Â  Â  ui.pricePerKgInput.readOnly = state.price;
Â  Â  Â  Â  if (state.price) {
Â  Â  Â  Â  Â  Â  ui.pricePerKgInput.classList.add('bg-stone-200', 'cursor-not-allowed');
Â  Â  Â  Â  Â  Â  ui.priceLockIcon.textContent = 'ğŸ”’';
Â  Â  Â  Â  Â  Â  ui.priceLockBtn.title = 'à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„à¸£à¸²à¸„à¸²';
Â  Â  Â  Â  Â  Â  ui.priceLockBtn.classList.replace('bg-gray-400', 'bg-sky-500');
Â  Â  Â  Â  Â  Â  ui.priceLockBtn.classList.replace('hover:bg-gray-500', 'hover:bg-sky-600');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  ui.pricePerKgInput.classList.remove('bg-stone-200', 'cursor-not-allowed');
Â  Â  Â  Â  Â  Â  ui.priceLockIcon.textContent = 'ğŸ”“';
Â  Â  Â  Â  Â  Â  ui.priceLockBtn.title = 'à¸¥à¹‡à¸­à¸„à¸£à¸²à¸„à¸²';
Â  Â  Â  Â  Â  Â  ui.priceLockBtn.classList.replace('bg-sky-500', 'bg-gray-400');
Â  Â  Â  Â  Â  Â  ui.priceLockBtn.classList.replace('hover:bg-sky-600', 'hover:bg-gray-500');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Type Lock UI
Â  Â  Â  Â  const typeRadios = document.querySelectorAll('.receipt-type-radio');
Â  Â  Â  Â  typeRadios.forEach(radio => radio.disabled = state.type);
Â  Â  Â  Â  if (state.type) {
Â  Â  Â  Â  Â  Â  ui.typeLockIcon.textContent = 'ğŸ”’';
Â  Â  Â  Â  Â  Â  ui.typeLockBtn.title = 'à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„à¸›à¸£à¸°à¹€à¸ à¸—';
Â  Â  Â  Â  Â  Â  ui.typeLockBtn.classList.replace('bg-gray-400', 'bg-sky-500');
Â  Â  Â  Â  Â  Â  ui.typeLockBtn.classList.replace('hover:bg-gray-500', 'hover:bg-sky-600');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  ui.typeLockIcon.textContent = 'ğŸ”“';
Â  Â  Â  Â  Â  Â  ui.typeLockBtn.title = 'à¸¥à¹‡à¸­à¸„à¸›à¸£à¸°à¹€à¸ à¸—';
Â  Â  Â  Â  Â  Â  ui.typeLockBtn.classList.replace('bg-sky-500', 'bg-gray-400');
Â  Â  Â  Â  Â  Â  ui.typeLockBtn.classList.replace('hover:bg-sky-600', 'hover:bg-gray-500');
Â  Â  Â  Â  }
Â  Â  }

    // ### MODIFIED ###: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ toggle à¹ƒà¸«à¹‰à¸—à¸³à¸‡à¸²à¸™à¸à¸±à¸š state à¸‚à¸­à¸‡à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
Â  Â  function togglePriceLock() {
Â  Â  Â  Â  const currentScaleId = ui.selectedReceiptScale.value;
Â  Â  Â  Â  if (!currentScaleId) return;
Â  Â  Â  Â  lockStates[currentScaleId].price = !lockStates[currentScaleId].price;
Â  Â  Â  Â  applyLockState(currentScaleId);
Â  Â  }
Â  Â Â 
    // ### MODIFIED ###: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ toggle à¹ƒà¸«à¹‰à¸—à¸³à¸‡à¸²à¸™à¸à¸±à¸š state à¸‚à¸­à¸‡à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
Â  Â  function toggleTypeLock() {
Â  Â  Â  Â  const currentScaleId = ui.selectedReceiptScale.value;
Â  Â  Â  Â  if (!currentScaleId) return;
Â  Â  Â  Â  lockStates[currentScaleId].type = !lockStates[currentScaleId].type;
Â  Â  Â  Â  applyLockState(currentScaleId);
Â  Â  }
Â  Â Â 
Â  Â  async function handleSave() {
Â  Â  Â  Â  if (!salesCollectionRef || !countersDocRef) return showAlert('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ');
Â  Â  Â  Â  const seller = ui.sellerNameInput.value.trim();
Â  Â  Â  Â  const date = ui.receiptDateInput.valueAsDate;
Â  Â  Â  Â  const scaleNumber = ui.selectedReceiptScale.value;
Â  Â  Â  Â  const bagsCount = parseInt(ui.receiptBagsCount.value) || 0;
Â  Â  Â  Â  const weight = parseFloat(ui.totalWeightEl.textContent) || 0;
Â  Â  Â  Â  const price = parseFloat(ui.pricePerKgInput.value) || 0;
Â  Â  Â  Â  const total = parseFloat(ui.totalAmountEl.textContent.replace(/,/g, '')) || 0;
Â  Â  Â  Â  const weightInputs = Array.from(ui.weightInputsContainer.querySelectorAll('.weight-input')).map(input => parseFloat(input.value) || 0).filter(v => v > 0);
Â  Â  Â  Â  const receiptType = document.querySelector('input[name="receipt_type"]:checked')?.value || null;

Â  Â  Â  Â  if (!scaleNumber) return showAlert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸­à¸­à¸à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸à¹ˆà¸­à¸™');
Â  Â  Â  Â  if (weightInputs.length === 0 || !seller || !date || weight <= 0 || price <= 0) return showAlert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸šà¸–à¹‰à¸§à¸™: à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢, à¸§à¸±à¸™à¸—à¸µà¹ˆ, à¸™à¹‰à¸³à¸«à¸™à¸±à¸ à¹à¸¥à¸°à¸£à¸²à¸„à¸²');
Â  Â  Â  Â  if (total <= 0) return showAlert('à¸¢à¸­à¸”à¸£à¸§à¸¡à¸•à¹‰à¸­à¸‡à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 0 à¸šà¸²à¸—');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const saleData = { seller, date, scaleNumber, bagsCount, weight, weights: weightInputs, price, total, receiptType, timestamp: new Date(), userId };
Â  Â  Â  Â Â 
Â  Â  Â  Â  ui.saveButton.disabled = true;
Â  Â  Â  Â  ui.saveButton.textContent = 'à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...';
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (editingId) {
Â  Â  Â  Â  Â  Â  Â  Â  const originalDoc = localSalesData.find(s => s.id === editingId);
Â  Â  Â  Â  Â  Â  Â  Â  if (originalDoc) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saleData.dailyQueueNumber = originalDoc.dailyQueueNumber;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saleData.receiptId = originalDoc.receiptId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saleData.printCount = originalDoc.printCount || 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(salesCollectionRef, editingId), saleData);
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  Â  Â  Â  Â  clearForm();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  await runTransaction(db, async (transaction) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const counterDoc = await transaction.get(countersDocRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateKey = getUTCDateKey(date);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let nextQueueNumber = (counterDoc.exists() && counterDoc.data()[dateKey]) ? counterDoc.data()[dateKey] + 1 : 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let nextReceiptIndex = (counterDoc.exists() && counterDoc.data().lastReceiptIndex) ? counterDoc.data().lastReceiptIndex + 1 : 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const year = now.getFullYear().toString().slice(-2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const month = (now.getMonth() + 1).toString().padStart(2, '0');
Â  Â  Â  Â  Â  _2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saleData.dailyQueueNumber = nextQueueNumber;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saleData.receiptId = `${year}${month}${day}-${String(nextReceiptIndex).padStart(4, '0')}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saleData.printCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newCounterData = { [dateKey]: nextQueueNumber, lastReceiptIndex: nextReceiptIndex };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction.set(countersDocRef, newCounterData, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction.set(doc(salesCollectionRef), saleData);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  Â  Â  Â  Â  clearForm();
Â  Â  Â  Â  Â  Â  Â  Â  populateSellerDatalist(scaleNumber);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error saving document: ", error);
Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸: ${error.message}`);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  ui.saveButton.disabled = false;
Â  Â  Â  Â  Â  Â  ui.saveButton.textContent = editingId ? 'à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥' : 'à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥';
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function handleTableClick(e) {
Â  Â  Â  Â  const target = e.target.closest('button');
Â  Â  Â  Â  if (!target) return;
Â  Â  Â  Â  const id = target.dataset.id;
Â  Â  Â  Â  const saleToProcess = localSalesData.find(sale => sale.id === id);
Â  Â  Â  Â  if (!saleToProcess) return;
Â  Â  Â  Â  if (target.classList.contains('delete-btn')) {
Â  Â  Â  Â  Â  Â  showConfirm('à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰?', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(salesCollectionRef, id));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¸š: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else if (target.classList.contains('edit-btn')) {
Â  Â  Â  Â  Â  Â  editingId = id;
Â  Â  Â  Â  Â  Â  if (saleToProcess.scaleNumber) {
Â  Â  Â  Â  Â  Â  Â  Â  const scaleBtn = ui.receiptScaleSubTabs.querySelector(`.receipt-scale-sub-btn[data-scale="${saleToProcess.scaleNumber}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if (scaleBtn) scaleBtn.click();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ui.sellerNameInput.value = saleToProcess.seller;
Â  Â  Â  Â  Â  Â  ui.receiptBagsCount.value = saleToProcess.bagsCount || '';
Â  Â  Â  Â  Â  Â  ui.receiptDateInput.value = saleToProcess.date.toDate().toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  ui.pricePerKgInput.value = saleToProcess.price;

Â  Â  Â  Â  Â  Â  document.querySelectorAll('.receipt-type-radio').forEach(radio => {
Â  Â  Â  Â  Â  Â  Â  Â  radio.checked = (radio.value === saleToProcess.receiptType);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const weightInputs = ui.weightInputsContainer.querySelectorAll('.weight-input');
Â  Â  Â  Â  Â  Â  weightInputs.forEach((input, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  input.value = saleToProcess.weights[index] || '';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  calculateTotals();
Â  Â  Â  Â  Â  Â  ui.saveButton.textContent = 'à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥';
Â  Â  Â  Â  Â  Â  ui.cancelEditButton.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  switchToTab('tab-receipt');
Â  Â  Â  Â  Â  Â  _switchToSubTab('receipt', 'receipt-form');
Â  Â  Â  Â  Â  Â  window.scrollTo({ top: 0, behavior: 'smooth' });
Â  Â  Â  Â  } else if (target.classList.contains('reprint-btn')) {
Â  Â  Â  Â  Â  Â  showConfirm('à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸à¸´à¸¡à¸à¹Œà¹ƒà¸Šà¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ? à¸£à¸°à¸šà¸šà¸ˆà¸°à¸™à¸±à¸šà¸ˆà¸³à¸™à¸§à¸™à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸à¸´à¸¡à¸à¹Œ', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentCount = saleToProcess.printCount || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(salesCollectionRef, id), { printCount: currentCount + 1 });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updatedSaleDataForPrint = { ...saleToProcess, printCount: currentCount + 1 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createPrintableReceipt(updatedSaleDataForPrint);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function updateDateDisplay() {
Â  Â  Â  Â  const date = ui.receiptDateInput.valueAsDate;
Â  Â  Â  Â  ui.dateDisplay.textContent = `(${(date || new Date()).toLocaleDateString('th-TH')})`;
Â  Â  }
Â  Â Â 
Â  Â  function createWeighingStationHTML(scaleId) {
Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="weighing-seller-${scaleId}" class="block text-sm font-medium text-stone-600 mb-1">à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="weighing-seller-${scaleId}" class="w-full p-3 border border-stone-300 rounded-lg shadow-sm" placeholder="à¸„à¹‰à¸™à¸«à¸²à¸«à¸£à¸·à¸­à¸›à¹‰à¸­à¸™à¸Šà¸·à¹ˆà¸­">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="weighing-weight-${scaleId}" class="block text-sm font-medium text-stone-600 mb-1">à¸ˆà¸³à¸™à¸§à¸™à¸–à¸¸à¸‡</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="weighing-weight-${scaleId}" class="w-full p-3 border border-stone-300 rounded-lg shadow-sm" step="any">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="save-weighing-${scaleId}" data-scale="${scaleId}" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">à¸šà¸±à¸™à¸—à¸¶à¸à¸ˆà¸³à¸™à¸§à¸™à¸–à¸¸à¸‡</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="mt-8 overflow-x-auto rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm text-left table-fixed">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-stone-100 sticky top-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-3 text-center w-14">à¸¥à¸³à¸”à¸±à¸š</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-3 w-48">à¸Šà¸·à¹ˆà¸­</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-3 text-right w-24">à¸ˆà¸³à¸™à¸§à¸™à¸–à¸¸à¸‡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-3 w-32">à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸—à¸µà¹ˆà¸Šà¸±à¹ˆà¸‡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-3 text-center">à¸ˆà¸±à¸”à¸à¸²à¸£</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="weighing-table-body-${scaleId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="5" class="text-center p-8 text-stone-400">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="border-t mt-8 pt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold text-stone-700 mb-3">à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡ (à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId})</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4 flex-wrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="print-weighing-history-${scaleId}" data-scale="${scaleId}" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-sky-700 transition-colors">ğŸ–¨ï¸ à¹€à¸£à¸µà¸¢à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡à¹€à¸à¸·à¹ˆà¸­à¸›à¸£à¸´à¹‰à¸™</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="export-weighing-history-${scaleId}" data-scale="${scaleId}" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition-colors">ğŸ“„ à¹à¸›à¸¥à¸‡à¹„à¸Ÿà¸¥à¹Œà¹€à¸›à¹‡à¸™ .xlsx</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  }
Â  Â Â 
Â  Â  function renderWeighingStations() {
Â  Â  Â  Â  for (let i = 1; i <= 4; i++) {
Â  Â  Â  Â  Â  Â  const tabContent = document.getElementById(`weighing-scale-${i}-content`);
Â  Â  Â  Â  Â  Â  if (tabContent) {
Â  Â  Â  Â  Â  Â  Â  Â  tabContent.innerHTML = createWeighingStationHTML(i);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`save-weighing-${i}`).addEventListener('click', saveWeighing);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`weighing-table-body-${i}`).addEventListener('click', handleWeighingTableClick);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`print-weighing-history-${i}`).addEventListener('click', (e) => printWeighingHistory(e.currentTarget.dataset.scale));
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`export-weighing-history-${i}`).addEventListener('click', (e) => exportWeighingHistoryToXLSX(e.currentTarget.dataset.scale));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function printWeighingHistory(scaleId) {
Â  Â  Â  Â  if (!localWeighingData) return showAlert('à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸§à¸²à¸‡à¸¢à¸²à¸‡à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¹à¸à¹‚à¸«à¸¥à¸”');
Â  Â  Â  Â  const scaleData = localWeighingData.filter(record => record.scaleId == scaleId);
Â  Â  Â  Â  if (scaleData.length === 0) return showAlert(`à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸§à¸²à¸‡à¸¢à¸²à¸‡à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId}`);
Â  Â  Â  Â  const uniqueDates = Array.from(new Set(scaleData.map(r => r.timestamp.toDate().toISOString().split('T')[0]))).sort((a, b) => new Date(b) - new Date(a));
Â  Â  Â  Â  let modalContentHTML = `
Â  Â  Â  Â  Â  Â  <div class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal-date-select" class="block text-sm font-medium text-stone-700">à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸à¸´à¸¡à¸à¹Œ:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modal-date-select" class="w-full p-2 border border-stone-300 rounded-md shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${uniqueDates.map(dateStr => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateObj = new Date(dateStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedDate = dateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<option value="${dateStr}">${formattedDate}</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  showModal(`à¸à¸´à¸¡à¸à¹Œà¸£à¸²à¸¢à¸‡à¸²à¸™à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡ (à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId})`, modalContentHTML, [{
Â  Â  Â  Â  Â  Â  text: 'ğŸ–¨ï¸ à¸à¸´à¸¡à¸à¹Œà¸£à¸²à¸¢à¸‡à¸²à¸™',
Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-sky-600 text-base font-medium text-white hover:bg-sky-700',
Â  Â  Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  Â  Â  Â  const selectedDate = document.getElementById('modal-date-select').value;
Â  Â  Â  Â  Â  Â  Â  Â  if (!selectedDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆà¸à¹ˆà¸­à¸™');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => printWeighingHistory(scaleId), 350);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const reportData = scaleData.filter(record => record.timestamp.toDate().toISOString().split('T')[0] === selectedDate).sort((a, b) => (a.dailyQueueNumber || 0) - (b.dailyQueueNumber || 0));
Â  Â  Â  Â  Â  Â  Â  Â  const formattedPrintDate = new Date(selectedDate).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
Â  Â  Â  Â  Â  Â  Â  Â  const tableRows = reportData.map(record => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-center">${record.dailyQueueNumber}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2">${record.sellerName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 text-right">${record.bags}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-2 border-l border-black"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  const reportHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-8 bg-white text-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold">à¸£à¸²à¸¢à¸‡à¸²à¸™à¸à¸²à¸£à¸£à¸±à¸šà¸§à¸²à¸‡à¸¢à¸²à¸‡ à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™à¸—à¸µà¹ˆ ${formattedPrintDate}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg">à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm border-collapse border border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-stone-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 10%;">à¸¥à¸³à¸”à¸±à¸š</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 40%;">à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black text-right" style="width: 20%;">à¸ˆà¸³à¸™à¸§à¸™à¸–à¸¸à¸‡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 py-2 border-r border-black" style="width: 30%;">à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸—à¸µà¹ˆà¸Šà¸±à¹ˆà¸‡ (à¸à¸.)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${tableRows}</tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  ui.printArea.innerHTML = reportHTML;
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => window.print(), 100);
Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, {
Â  Â  Â  Â  Â  Â  text: 'à¸¢à¸à¹€à¸¥à¸´à¸',
Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto mt-2 sm:mt-0 inline-flex justify-center rounded-md border border-stone-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-stone-700 hover:bg-stone-50'
Â  Â  Â  Â  }]);
Â  Â  }
Â  Â Â 
Â  Â  function exportWeighingHistoryToXLSX(scaleId) {
Â  Â  Â  Â  if (!localWeighingData) return showAlert('à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸§à¸²à¸‡à¸¢à¸²à¸‡à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¹à¸à¹‚à¸«à¸¥à¸”');
Â  Â  Â  Â  const scaleData = localWeighingData.filter(record => record.scaleId == scaleId).sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
Â  Â  Â  Â  if (scaleData.length === 0) return showAlert(`à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸§à¸²à¸‡à¸¢à¸²à¸‡à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId} à¹€à¸à¸·à¹ˆà¸­ Export`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const headers = ['à¸§à¸±à¸™à¸—à¸µà¹ˆ', 'à¹€à¸§à¸¥à¸²', 'à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢', 'à¸ˆà¸³à¸™à¸§à¸™à¸–à¸¸à¸‡'];
Â  Â  Â  Â  const exportData = [headers];
Â  Â  Â  Â  scaleData.forEach(record => {
Â  Â  Â  Â  Â  Â  const timestamp = record.timestamp.toDate();
Â  Â  Â  Â  Â  Â  exportData.push([timestamp.toLocaleDateString('th-TH'), timestamp.toLocaleTimeString('th-TH'), record.sellerName, record.bags]);
Â  Â  Â  Â  });
Â  Â  Â  Â  const ws = XLSX.utils.aoa_to_sheet(exportData);
Â  Â  Â  Â  ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 30 }, { wch: 15 }];
Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, `à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scaleId}`);
Â  Â  Â  Â  XLSX.writeFile(wb, `weighing-history-scale-${scaleId}.xlsx`);
Â  Â  }
Â  Â Â 
Â  Â  function exportToExcel() {
Â  Â  Â  Â  if (localSalesData.length === 0) return showAlert('à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸‚à¸²à¸¢à¸ªà¸³à¸«à¸£à¸±à¸š Export');
Â  Â  Â  Â  const salesByDate = localSalesData.reduce((acc, sale) => {
Â  Â  Â  Â  Â  Â  const d = sale.date.toDate();
Â  Â  Â  Â  Â  Â  const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
Â  Â  Â  Â  Â  Â  if (!acc[dateKey]) acc[dateKey] = [];
Â  Â  Â  Â  Â  Â  acc[dateKey].push(sale);
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});
Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  const sortedDates = Object.keys(salesByDate).sort((a, b) => new Date(b) - new Date(a));
Â  Â  Â  Â  sortedDates.forEach(dateKey => {
Â  Â  Â  Â  Â  Â  const daySales = salesByDate[dateKey].sort((a, b) => (a.dailyQueueNumber || 0) - (b.dailyQueueNumber || 0));
Â  Â  Â  Â  Â  Â  const headers = ['à¸„à¸´à¸§', 'à¸§à¸±à¸™à¸—à¸µà¹ˆ', 'à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢', 'à¸™à¹‰à¸³à¸«à¸™à¸±à¸ (à¸à¸.)', 'à¸£à¸²à¸„à¸²/à¸«à¸™à¹ˆà¸§à¸¢ (à¸šà¸²à¸—)', 'à¸¢à¸­à¸”à¸£à¸§à¸¡ (à¸šà¸²à¸—)', 'à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ'];
Â  Â  Â  Â  Â  Â  const exportData = [headers];
Â  Â  Â  Â  Â  Â  daySales.forEach(sale => {
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([sale.dailyQueueNumber || '', sale.date.toDate().toLocaleDateString('th-TH'), sale.seller, sale.weight, sale.price, sale.total, sale.scaleNumber || '']);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const ws = XLSX.utils.aoa_to_sheet(exportData);
Â  Â  Â  Â  Â  Â  ws['!cols'] = [{ wch: 5 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 }];
Â  Â  Â  Â  Â  Â  for (let R = 1; R < exportData.length; ++R) {
Â  Â  Â  Â  Â  Â  Â  Â  for (let C of [3, 4, 5]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cell_ref]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ws[cell_ref].t = 'n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ws[cell_ref].z = '#,##0.00';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const dateParts = dateKey.split('-');
Â  Â  Â  Â  Â  Â  const sheetName = `${dateParts[2]}-${dateParts[1]}-${dateParts[0].substring(2)}`;
Â  Â  Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, sheetName);
Â  Â  Â  Â  });
Â  Â  Â  Â  const today = new Date().toISOString().slice(0, 10);
Â  Â  Â  Â  XLSX.writeFile(wb, `daily-sales-report-${today}.xlsx`);
Â  Â  }
Â  Â Â 
Â  Â  async function saveWeighing(event) {
Â  Â  Â  Â  if (!weighingsCollectionRef) return showAlert('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ');
Â  Â  Â  Â  const scaleId = parseInt(event.target.dataset.scale);
Â  Â  Â  Â  const sellerNameInput = document.getElementById(`weighing-seller-${scaleId}`);
Â  Â  Â  Â  const bagsInput = document.getElementById(`weighing-weight-${scaleId}`);
Â  Â  Â  Â  const sellerName = sellerNameInput.value.trim();
Â  Â  Â  Â  const bags = parseFloat(bagsInput.value);
Â  Â  Â  Â  if (!sellerName || !bags || bags <= 0) return showAlert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸‚à¸²à¸¢à¹à¸¥à¸°à¸ˆà¸³à¸™à¸§à¸™à¸–à¸¸à¸‡à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (editingWeighingId) {
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(weighingsCollectionRef, editingWeighingId), { sellerName, bags });
Â  Â  Â  Â  Â  Â  Â  Â  editingWeighingId = null;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const todayStart = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  todayStart.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const todaysEntriesOnScale = localWeighingData.filter(d => d.scaleId === scaleId && d.timestamp.toDate() >= todayStart);
Â  Â  Â  Â  Â  Â  Â  Â  const newQueueNumber = todaysEntriesOnScale.length + 1;
Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(weighingsCollectionRef, { sellerName, bags, scaleId, timestamp: new Date(), userId, dailyQueueNumber: newQueueNumber });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  sellerNameInput.value = '';
Â  Â  Â  Â  Â  Â  bagsInput.value = '';
Â  Â  Â  Â  Â  Â  sellerNameInput.focus();
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸: ${error.message}`);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function calculateSummaryTotalWeight() {
Â  Â  Â  Â  const totalBags = parseFloat(ui.summaryTotalBags.textContent) || 0;
Â  Â  Â  Â  const multiplier = parseFloat(ui.summaryMultiplierWeight.value) || 0;
Â  Â  Â  Â  ui.summaryCalculatedWeight.textContent = (totalBags * multiplier).toFixed(2);
Â  Â  }
Â  Â Â 
Â  Â  function updateWeighingSummary() {
Â  Â  Â  Â  let totalBags = 0;
Â  Â  Â  Â  for (const scaleId in dailyWeighingData) {
Â  Â  Â  Â  Â  Â  totalBags += dailyWeighingData[scaleId].reduce((sum, doc) => sum + doc.bags, 0);
Â  Â  Â  Â  }
Â  Â  Â  Â  ui.summaryTotalBags.textContent = totalBags;
Â  Â  Â  Â  calculateSummaryTotalWeight();
Â  Â  }
Â  Â Â 
Â  Â  async function deleteAllTodaysWeighings() {
Â  Â  Â  Â  showConfirm(
Â  Â  Â  Â  Â  Â  'à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸§à¸²à¸‡à¸¢à¸²à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸‚à¸­à¸‡à¸§à¸±à¸™à¸™à¸µà¹‰? <strong>à¸à¸²à¸£à¸à¸£à¸°à¸—à¸³à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸šà¹„à¸”à¹‰</strong>',
Â  Â  Â  Â  Â  Â  async () => {
Â  Â  Â  Â  Â  Â  Â  Â  const todayStart = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  todayStart.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(weighingsCollectionRef, where("timestamp", ">=", todayStart));
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (querySnapshot.empty) return showAlert('à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸§à¸²à¸‡à¸¢à¸²à¸‡à¸‚à¸­à¸‡à¸§à¸±à¸™à¸™à¸µà¹‰à¹ƒà¸«à¹‰à¸¥à¸š');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach(doc => batch.delete(doc.ref));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ui.summaryMultiplierWeight.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸§à¸²à¸‡à¸¢à¸²à¸‡à¸‚à¸­à¸‡à¸§à¸±à¸™à¸™à¸µà¹‰à¸ˆà¸³à¸™à¸§à¸™ ${querySnapshot.size} à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§`);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  );
Â  Â  }
Â  Â Â 
Â  Â  function setupWeighingListeners() {
Â  Â  Â  Â  if (!weighingsCollectionRef) return;
Â  Â  Â  Â  for (let i = 1; i <= 4; i++) {
Â  Â  Â  Â  Â  Â  const q = query(weighingsCollectionRef, where("scaleId", "==", i));
Â  Â  Â  Â  Â  Â  if (unsubscribeWeighings[i]) unsubscribeWeighings[i]();
Â  Â  Â  Â  Â  Â  unsubscribeWeighings[i] = onSnapshot(q, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  const todayStart = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  todayStart.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const tableBody = document.getElementById(`weighing-table-body-${i}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (!tableBody) return;
Â  Â  Â  Â  Â  Â  Â  Â  tableBody.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  Â  Â  const todaysDocs = docs.filter(data => data.timestamp.toDate() >= todayStart);
Â  Â  Â  Â  Â  Â  Â  Â  dailyWeighingData[i] = todaysDocs;
Â  Â  Â  Â  Â  Â  Â  Â  updateWeighingSummary();
Â  Â  Â  Â  Â  Â  Â  Â  if (todaysDocs.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-stone-400">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£</td></tr>';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  todaysDocs.sort((a, b) => (a.dailyQueueNumber || 999) - (b.dailyQueueNumber || 999)).forEach(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.className = 'border-b odd:bg-stone-50';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-3 text-center font-bold text-lg">${data.dailyQueueNumber || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-3 font-medium truncate">${data.sellerName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-3 text-right font-bold text-amber-700">${data.bags}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-3"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-2 py-3 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-center gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-queue-btn text-green-600 p-2 rounded-md hover:bg-green-100" data-id="${data.id}" data-scale="${i}" data-current-queue="${data.dailyQueueNumber}" title="à¹à¸à¹‰à¹„à¸‚à¸¥à¸³à¸”à¸±à¸š">ğŸ”„</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-weighing-btn text-blue-600 p-2 rounded-md hover:bg-blue-100" data-id="${data.id}" data-scale="${i}" title="à¹à¸à¹‰à¹„à¸‚">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-weighing-btn text-red-600 p-2 rounded-md hover:bg-red-100" data-id="${data.id}" title="à¸¥à¸š">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableBody.appendChild(row);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function populateSellerDatalist(scaleNumber) {
Â  Â  Â  Â  if (!localWeighingData || !localSalesData || !scaleNumber) {
Â  Â  Â  Â  Â  Â  if (ui.sellerNameList) ui.sellerNameList.innerHTML = '';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  };

Â  Â  Â  Â  const allWeighingDates = localWeighingData.map(w => getUTCDateKey(w.timestamp.toDate())).filter(Boolean);
Â  Â  Â  Â  if (allWeighingDates.length === 0) {
Â  Â  Â  Â  Â  Â  if (ui.sellerNameList) ui.sellerNameList.innerHTML = '';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const mostRecentWeighingDate = allWeighingDates.sort().pop();

Â  Â  Â  Â  const sortedWeighingEntries = localWeighingData
Â  Â  Â  Â  Â  Â  .filter(w =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  w.scaleId == scaleNumber &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  getUTCDateKey(w.timestamp.toDate()) === mostRecentWeighingDate
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  .sort((a, b) => (a.dailyQueueNumber || 999) - (b.dailyQueueNumber || 999));

Â  Â  Â  Â  const sellersWithReceiptsToday = new Set(
Â  Â  Â  Â  Â  Â  localSalesData
Â  Â  Â  Â  Â  Â  Â  Â  .filter(s => getUTCDateKey(s.date.toDate()) === mostRecentWeighingDate && s.scaleNumber == scaleNumber)
Â  Â  Â  Â  Â  Â  Â  Â  .map(s => s.seller)
Â  Â  Â  Â  );

Â  Â  Â  Â  const datalist = ui.sellerNameList;
Â  Â  Â  Â  if (datalist) {
Â  Â  Â  Â  Â  Â  datalist.innerHTML = '';
Â  Â  Â  Â  Â  Â  sortedWeighingEntries.forEach(entry => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!sellersWithReceiptsToday.has(entry.sellerName)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  option.value = entry.sellerName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datalist.appendChild(option);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  async function handleWeighingTableClick(e) {
Â  Â  Â  Â  const target = e.target.closest('button');
Â  Â  Â  Â  if (!target) return;
Â  Â  Â  Â  const id = target.dataset.id;
Â  Â  Â  Â  const scaleId = parseInt(target.dataset.scale);
Â  Â  Â  Â  if (target.classList.contains('delete-weighing-btn')) {
Â  Â  Â  Â  Â  Â  showConfirm('à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸§à¸²à¸‡à¸¢à¸²à¸‡à¸™à¸µà¹‰?', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(weighingsCollectionRef, id));
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else if (target.classList.contains('edit-weighing-btn')) {
Â  Â  Â  Â  Â  Â  const docSnap = await getDoc(doc(weighingsCollectionRef, id));
Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`weighing-seller-${scaleId}`).value = data.sellerName;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`weighing-weight-${scaleId}`).value = data.bags;
Â  Â  Â  Â  Â  Â  Â  Â  editingWeighingId = id;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`weighing-seller-${scaleId}`).focus();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else if (target.classList.contains('edit-queue-btn')) {
Â  Â  Â  Â  Â  Â  const currentQueue = target.dataset.currentQueue;
Â  Â  Â  Â  Â  Â  const modalContentHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-stone-500 mb-4 text-left">à¹à¸à¹‰à¹„à¸‚à¸¥à¸³à¸”à¸±à¸šà¸ªà¸³à¸«à¸£à¸±à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰ (à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸„à¸·à¸­ ${currentQueue})</p>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="modal-edit-queue-input" class="w-full p-3 border border-stone-300 rounded-lg text-center text-xl" value="${currentQueue}">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="edit-queue-error" class="text-sm text-red-600 text-center hidden mt-2"></p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  showModal(`à¹à¸à¹‰à¹„à¸‚à¸¥à¸³à¸”à¸±à¸š`, modalContentHTML, [{
Â  Â  Â  Â  Â  Â  Â  Â  text: 'à¸šà¸±à¸™à¸—à¸¶à¸',
Â  Â  Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700',
Â  Â  Â  Â  Â  Â  Â  Â  onClick: async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inputEl = document.getElementById('modal-edit-queue-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('edit-queue-error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newQueue = parseInt(inputEl.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(newQueue) || newQueue <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸¥à¸³à¸”à¸±à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 0)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const todayStart = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  todayStart.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isDuplicate = localWeighingData.some(d =>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.id !== id &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.scaleId === scaleId &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.timestamp.toDate() >= todayStart &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.dailyQueueNumber === newQueue
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isDuplicate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = `à¸¥à¸³à¸”à¸±à¸šà¸—à¸µà¹ˆ ${newQueue} à¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§ à¸à¸£à¸¸à¸“à¸²à¹ƒà¸Šà¹‰à¹€à¸¥à¸‚à¸­à¸·à¹ˆà¸™`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(weighingsCollectionRef, id), { dailyQueueNumber: newQueue });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¹à¸à¹‰à¹„à¸‚à¸¥à¸³à¸”à¸±à¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = `à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, {
Â  Â  Â  Â  Â  Â  Â  Â  text: 'à¸¢à¸à¹€à¸¥à¸´à¸',
Â  Â  Â  Â  Â  Â  Â  Â  classes: 'w-full sm:w-auto mt-2 sm:mt-0 inline-flex justify-center rounded-md border border-stone-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-stone-700 hover:bg-stone-50'
Â  Â  Â  Â  Â  Â  }]);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  const scaleColorPalette = [
Â  Â  Â  Â  { bg: 'bg-red-100', border: 'border-red-300', textH: 'text-red-800', textP: 'text-red-900', textS: 'text-red-700' },Â 
Â  Â  Â  Â  { bg: 'bg-sky-100', border: 'border-sky-300', textH: 'text-sky-800', textP: 'text-sky-900', textS: 'text-sky-700' },
Â  Â  Â  Â  { bg: 'bg-green-100', border: 'border-green-300', textH: 'text-green-800', textP: 'text-green-900', textS: 'text-green-700' },
Â  Â  Â  Â  { bg: 'bg-yellow-100', border: 'border-yellow-300', textH: 'text-yellow-800', textP: 'text-yellow-900', textS: 'text-yellow-700' }
Â  Â  ];
Â  Â  const defaultScaleColor = { bg: 'bg-stone-100', border: 'border-stone-300', textH: 'text-stone-800', textP: 'text-stone-900', textS: 'text-stone-700' };
Â  Â Â 
Â  Â  function renderScaleSummaries(container, totalContainer, totalWeightEl, totalAmountEl) {
Â  Â  Â  Â  if(!container || !totalContainer || !totalWeightEl || !totalAmountEl) return;

Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  today.setHours(0, 0, 0, 0);
Â  Â  Â  Â  const salesByScaleToday = localSalesData.reduce((acc, sale) => {
Â  Â  Â  Â  Â  Â  const saleDate = sale.date.toDate();
Â  Â  Â  Â  Â  Â  const todayStart = new Date();
Â  Â  Â  Â  Â  Â  todayStart.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  if (saleDate >= todayStart) {
Â  Â  Â  Â  Â  Â  Â  Â  const scale = sale.scaleNumber || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸';
Â  Â  Â  Â  Â  Â  Â  Â  if (!acc[scale]) acc[scale] = { totalWeight: 0, totalAmount: 0, count: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  acc[scale].totalWeight += sale.weight;
Â  Â  Â  Â  Â  Â  Â  Â  acc[scale].totalAmount += sale.total;
Â  Â  Â  Â  Â  Â  Â  Â  acc[scale].count++;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});
Â  Â  Â  Â Â 
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  if (Object.keys(salesByScaleToday).length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<div class="col-span-full text-center text-stone-500 py-4">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸‚à¸²à¸¢à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸±à¸™à¸™à¸µà¹‰</div>';
Â  Â  Â  Â  Â  Â  totalContainer.classList.add('hidden');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  let totalWeightToday = 0;
Â  Â  Â  Â  let totalAmountToday = 0;
Â  Â  Â  Â  Object.keys(salesByScaleToday).sort().forEach(scale => {
Â  Â  Â  Â  Â  Â  const summary = salesByScaleToday[scale];
Â  Â  Â  Â  Â  Â  totalWeightToday += summary.totalWeight;
Â  Â  Â  Â  Â  Â  totalAmountToday += summary.totalAmount;
Â  Â  Â  Â  Â  Â  let colors;
Â  Â  Â  Â  Â  Â  const scaleNum = parseInt(scale);
Â  Â  Â  Â  Â  Â  colors = (scaleNum > 0) ? scaleColorPalette[(scaleNum - 1) % scaleColorPalette.length] : defaultScaleColor;
Â  Â  Â  Â  Â  Â  const summaryHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="${colors.bg} border ${colors.border} p-3 rounded-lg text-center shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium ${colors.textH}">à¸•à¸²à¸Šà¸±à¹ˆà¸‡à¸—à¸µà¹ˆ ${scale}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-bold ${colors.textP}">${summary.totalWeight.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})} à¸à¸.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm ${colors.textS}">${summary.totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})} à¸šà¸²à¸—</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  container.insertAdjacentHTML('beforeend', summaryHtml);
Â  Â  Â  Â  });
Â  Â  Â  Â  totalWeightEl.textContent = totalWeightToday.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
Â  Â  Â  Â  totalAmountEl.textContent = totalAmountToday.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
Â  Â  Â  Â  totalContainer.classList.remove('hidden');
Â  Â  }
Â  Â Â 
Â  Â  function filterAndRenderSalesTable() {
Â  Â  Â  Â  const searchTerm = ui.searchBox.value.toLowerCase().trim();
Â  Â  Â  Â  const selectedDate = ui.reportDateSelect.value;
Â  Â  Â  Â  let dataToRender = localSalesData;
Â  Â  Â  Â  if (selectedDate) {
Â  Â  Â  Â  Â  Â  dataToRender = dataToRender.filter(sale => getUTCDateKey(sale.date.toDate()) === selectedDate);
Â  Â  Â  Â  } else if (!searchTerm) {
Â  Â  Â  Â  Â  Â  const todayStart = new Date();
Â  Â  Â  Â  Â  Â  todayStart.setHours(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  const todayEnd = new Date();
Â  Â  Â  Â  Â  Â  todayEnd.setHours(23, 59, 59, 999);
Â  Â  Â  Â  Â  Â  dataToRender = dataToRender.filter(sale => {
Â  Â  Â  Â  Â  Â  Â  Â  const saleDate = sale.date.toDate();
Â  Â  Â  Â  Â  Â  Â  Â  return saleDate >= todayStart && saleDate <= todayEnd;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  if (searchTerm) {
Â  Â  Â  Â  Â  Â  dataToRender = dataToRender.filter(sale =>
Â  Â  Â  Â  Â  Â  Â  Â  sale.seller.toLowerCase().includes(searchTerm) ||
Â  Â  Â  Â  Â  Â  Â  Â  (sale.dailyQueueNumber && sale.dailyQueueNumber.toString().includes(searchTerm)) ||
Â  Â  Â  Â  Â  Â  Â  Â  sale.date.toDate().toLocaleDateString('th-TH').includes(searchTerm)
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  }
Â  Â  Â  Â  renderTable(dataToRender);
Â  Â  }
Â  Â Â 
Â  Â  function populateReportDateSelector() {
Â  Â  Â  Â  const dateSet = new Set(localSalesData.map(sale => getUTCDateKey(sale.date.toDate())));
Â  Â  Â  Â  const sortedDates = Array.from(dateSet).sort((a, b) => b.localeCompare(a));
Â  Â  Â  Â  const currentValue = ui.reportDateSelect.value;
Â  Â  Â  Â  ui.reportDateSelect.innerHTML = '<option value="">--- à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™à¸™à¸µà¹‰ ---</option>';
Â  Â  Â  Â  sortedDates.forEach(dateStr => {
Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = dateStr;
Â  Â  Â  Â  Â  Â  const dateParts = dateStr.split('-');
Â  Â  Â  Â  Â  Â  option.textContent = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])).toLocaleDateString('th-TH', {
Â  Â  Â  Â  Â  Â  Â  Â  year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  ui.reportDateSelect.appendChild(option);
Â  Â  Â  Â  });
Â  Â  Â  Â  ui.reportDateSelect.value = currentValue;
Â  Â  }
Â  Â Â 
Â  Â  function populateTruckSummaryDateSelector() {
Â  Â  Â  Â  const dateSet = new Set(localSalesData.map(sale => getUTCDateKey(sale.date.toDate())));
Â  Â  Â  Â  const sortedDates = Array.from(dateSet).sort((a, b) => b.localeCompare(a));
Â  Â  Â  Â  const selector = ui.truckSummaryDate;
Â  Â  Â  Â  const currentValue = selector.value;
Â  Â  Â  Â  selector.innerHTML = '';
Â  Â  Â  Â  if (sortedDates.length === 0) {
Â  Â  Â  Â  Â  Â  selector.innerHTML = '<option value="">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</option>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  sortedDates.forEach(dateStr => {
Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = dateStr;
Â  Â  Â  Â  Â  Â  const dateParts = dateStr.split('-');
Â  Â  Â  Â  Â  Â  option.textContent = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])).toLocaleDateString('th-TH', {
Â  Â  Â  Â  Â  Â  Â  Â  year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  selector.appendChild(option);
Â  Â  Â  Â  });
Â  Â  Â  Â  if (currentValue && sortedDates.includes(currentValue)) {
Â  Â  Â  Â  Â  Â  selector.value = currentValue;
Â  Â  Â  Â  } else if (sortedDates.length > 0) {
Â  Â  Â  Â  Â  Â  selector.value = sortedDates[0];
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  async function backupData() {
Â  Â  Â  Â  showAlert('à¸à¸³à¸¥à¸±à¸‡à¹€à¸•à¸£à¸µà¸¢à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸£à¸­à¸‡...');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const backupObject = { sales: localSalesData, weighings: localWeighingData, truckLoads: localTruckLoads };
Â  Â  Â  Â  Â  Â  const jsonString = JSON.stringify(backupObject, null, 2);
Â  Â  Â  Â  Â  Â  const blob = new Blob([jsonString], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  Â  const today = new Date().toISOString().slice(0, 10);
Â  Â  Â  Â  Â  Â  a.download = `cup-rubber-backup-${today}.json`;
Â  Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  Â  hideModal();
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¸³à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: ${error.message}`);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  async function restoreDataFromFile(file) {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = async (e) => {
Â  Â  Â  Â  Â  Â  let data;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  data = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  const isValid = (data.sales && Array.isArray(data.sales)) && (data.weighings && Array.isArray(data.weighings)) && (data.truckLoads && Array.isArray(data.truckLoads));
Â  Â  Â  Â  Â  Â  Â  Â  if (!isValid) throw new Error("à¹„à¸Ÿà¸¥à¹Œà¸¡à¸µà¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ˆà¸±à¸à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ");
Â  Â  Â  Â  Â  Â  Â  Â  if (data.sales.length > 0 && (typeof data.sales[0].seller === 'undefined' || typeof data.sales[0].total === 'undefined')) throw new Error("à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™ 'sales' array à¸”à¸¹à¹€à¸«à¸¡à¸·à¸­à¸™à¸ˆà¸°à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡");
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  return showAlert(`à¹„à¸Ÿà¸¥à¹Œà¸ªà¸³à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  showConfirm(`à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸à¸¹à¹‰à¸„à¸·à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ? <strong>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸°à¸–à¸¹à¸à¸¥à¸šà¹à¸¥à¸°à¹à¸—à¸™à¸—à¸µà¹ˆà¸”à¹‰à¸§à¸¢à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œà¸™à¸µà¹‰</strong> à¸à¸²à¸£à¸à¸£à¸°à¸—à¸³à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸šà¹„à¸”à¹‰`,
Â  Â  Â  Â  Â  Â  Â  Â  async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥... à¸à¸£à¸¸à¸“à¸²à¸­à¸¢à¹ˆà¸²à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸™à¸µà¹‰');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const collections = [salesCollectionRef, weighingsCollectionRef, truckLoadsCollectionRef];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const collRef of collections) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!collRef) continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const allDocsSnapshot = await getDocs(collRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!allDocsSnapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deleteBatch = writeBatch(db);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allDocsSnapshot.forEach(doc => deleteBatch.delete(doc.ref));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteBatch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const restoreBatch = writeBatch(db);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.sales.forEach(sale => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newDocRef = doc(salesCollectionRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sale.date && sale.date.seconds) sale.date = new Date(sale.date.seconds * 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sale.timestamp && sale.timestamp.seconds) sale.timestamp = new Date(sale.timestamp.seconds * 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restoreBatch.set(newDocRef, sale);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.weighings.forEach(weighing => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newDocRef = doc(weighingsCollectionRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (weighing.timestamp && weighing.timestamp.seconds) weighing.timestamp = new Date(weighing.timestamp.seconds * 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restoreBatch.set(newDocRef, weighing);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.truckLoads && Array.isArray(data.truckLoads)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.truckLoads.forEach(load => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newDocRef = doc(truckLoadsCollectionRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (load.timestamp && load.timestamp.seconds) load.timestamp = new Date(load.timestamp.seconds * 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restoreBatch.set(newDocRef, load);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await restoreBatch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸à¸¹à¹‰à¸„à¸·à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸£à¹‰à¸²à¸¢à¹à¸£à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸à¸²à¸£à¸à¸¹à¹‰à¸„à¸·à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsText(file);
Â  Â  }
Â  Â Â 
Â  Â  function confirmDeleteAllData() {
Â  Â  Â  Â  showConfirm("à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸ˆà¸£à¸´à¸‡à¹† à¸«à¸£à¸·à¸­à¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”? à¸à¸²à¸£à¸à¸£à¸°à¸—à¸³à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸šà¹„à¸”à¹‰!", () => {
Â  Â  Â  Â  Â  Â  showConfirm("à¸™à¸µà¹ˆà¸„à¸·à¸­à¸à¸²à¸£à¸¢à¸·à¸™à¸¢à¸±à¸™à¸„à¸£à¸±à¹‰à¸‡à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢! à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸‚à¸²à¸¢, à¸à¸²à¸£à¸£à¸±à¸šà¸§à¸²à¸‡à¸¢à¸²à¸‡ à¹à¸¥à¸°à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¸¶à¹‰à¸™à¸£à¸–à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸°à¸–à¸¹à¸à¸¥à¸šà¸–à¸²à¸§à¸£ à¸à¸” 'à¸¢à¸·à¸™à¸¢à¸±à¸™' à¹€à¸à¸·à¹ˆà¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸•à¹ˆà¸­", async () => {
Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸à¸³à¸¥à¸±à¸‡à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”...');
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const collections = [salesCollectionRef, weighingsCollectionRef, truckLoadsCollectionRef, countersDocRef];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const ref of collections) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!ref) continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ref.type === 'document') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(ref);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const allDocsSnapshot = await getDocs(ref);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!allDocsSnapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allDocsSnapshot.forEach(doc => batch.delete(doc.ref));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function _switchToSubTab(type, targetId) {
Â  Â  Â  Â  const context = {
Â  Â  Â  Â  Â  Â  'weighing': { contents: document.querySelectorAll('.weighing-sub-content'), buttons: document.querySelectorAll('.weighing-sub-btn') },
Â  Â  Â  Â  Â  Â  'receipt': { contents: document.querySelectorAll('.receipt-sub-content'), buttons: document.querySelectorAll('.receipt-sub-btn') }
Â  Â  Â  Â  }[type];
Â  Â  Â  Â  if (!context) return;
Â  Â  Â  Â  context.contents.forEach(content => content.classList.remove('active'));
Â  Â  Â  Â  context.buttons.forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  const targetContent = document.getElementById(targetId + '-content');
Â  Â  Â  Â  const targetBtn = document.querySelector(`[data-subtab="${targetId}"]`);
Â  Â  Â  Â  if (targetContent) targetContent.classList.add('active');
Â  Â  Â  Â  if (targetBtn) targetBtn.classList.add('active');
Â  Â  Â  Â  if (targetId === 'receipt-truck-summary') {
Â  Â  Â  Â  Â  Â  const dateSelector = ui.truckSummaryDate;
Â  Â  Â  Â  Â  Â  if (dateSelector.options.length > 0 && dateSelector.options[0].value) {
Â  Â  Â  Â  Â  Â  Â  Â  dateSelector.value = dateSelector.options[0].value;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  calculateTruckSummary();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  getAnalytics(app);
Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  db = getFirestore(app);

        // ### MODIFIED ###: à¸ªà¸£à¹‰à¸²à¸‡ state à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸ªà¸³à¸«à¸£à¸±à¸š lockStates à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸•à¸²à¸Šà¸±à¹ˆà¸‡
Â  Â  Â  Â  for (let i = 1; i <= 4; i++) {
Â  Â  Â  Â  Â  Â  lockStates[i] = { price: false, type: false };
Â  Â  Â  Â  }

Â  Â  Â  Â  ui.changePasswordBtn.style.display = 'none';

Â  Â  Â  Â  ui.loginButton.addEventListener('click', handleLogin);
Â  Â  Â  Â  ui.passwordInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleLogin(); });
Â  Â  Â  Â  ui.logoutButton.addEventListener('click', handleLogout);

Â  Â  Â  Â  renderWeighingStations();
Â  Â  Â  Â  ui.tabs.addEventListener('click', (e) => { if (e.target.dataset.tab) switchToTab(e.target.dataset.tab); });
Â  Â  Â  Â  ui.saveButton.addEventListener('click', handleSave);
Â  Â  Â  Â  ui.cancelEditButton.addEventListener('click', clearForm);
Â  Â  Â  Â  ui.priceLockBtn.addEventListener('click', togglePriceLock);
Â  Â  Â  Â  ui.typeLockBtn.addEventListener('click', toggleTypeLock);
Â  Â  Â  Â  ui.salesTableBody.addEventListener('click', handleTableClick);
Â  Â  Â  Â  ui.printReportBtn.addEventListener('click', createDailySummaryReport);
Â  Â  Â  Â  ui.exportExcelBtn.addEventListener('click', exportToExcel);
Â  Â  Â  Â  if (ui.printDashboardBtn) ui.printDashboardBtn.addEventListener('click', () => window.print());
Â  Â  Â  Â  ui.receiptDateInput.addEventListener('input', updateDateDisplay);
Â  Â  Â  Â  [...document.querySelectorAll('.weight-input'), ui.pricePerKgInput].forEach(input => input.addEventListener('input', calculateTotals));
Â  Â  Â  Â  ui.searchBox.addEventListener('input', filterAndRenderSalesTable);
Â  Â  Â  Â  ui.reportDateSelect.addEventListener('change', filterAndRenderSalesTable);
Â  Â  Â  Â  ui.summaryMultiplierWeight.addEventListener('input', calculateSummaryTotalWeight);
Â  Â  Â  Â  ui.deleteAllWeighingsBtn.addEventListener('click', deleteAllTodaysWeighings);
Â  Â  Â  Â  ui.backupDataBtn.addEventListener('click', backupData);
Â  Â  Â  Â  ui.restoreDataBtn.addEventListener('click', () => ui.restoreFileInput.click());
