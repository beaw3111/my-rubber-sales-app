<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการขายยางก้อนถ้วย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        .tab-btn { transition: all 0.3s ease-in-out; }
        .tab-btn.active { border-color: #d97706; background-color: #fffbeb; color: #b45309; font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .weighing-sub-btn, .receipt-scale-sub-btn { transition: all 0.15s ease-in-out; }
        .weighing-sub-btn.active, .receipt-scale-sub-btn.active { background-color: #b45309; color: #ffffff; transform: translateY(1px); box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1); }
        .weighing-sub-content { display: none; }
        .weighing-sub-content.active { display: block; }
        .receipt-sub-btn { transition: all 0.15s ease-in-out; }
        .receipt-sub-btn.active { background-color: #b45309; color: #ffffff; transform: translateY(1px); box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1); }
        .receipt-sub-content { display: none; }
        .receipt-sub-content.active { display: block; }
        @media print {
            @page { size: A4; margin: 0; }
            body { margin: 0; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            .watermark { position: absolute; top: 50%; left: 55%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 4.5em; font-weight: 900; color: rgba(0, 0, 0, 0.08); pointer-events: none; white-space: nowrap; z-index: 10; }
        }
        /* ### CSS RULE FOR HIDING ELEMENTS BASED ON ROLE ### */
        .app-role-visitor .hide-for-visitor {
            display: none !important;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-stone-800 mb-2">ระบบจัดการขายยางก้อนถ้วย</h2>
            <p class="text-center text-stone-500 mb-6">กรุณาเข้าสู่ระบบ</p>
            <div class="space-y-4">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-stone-600">อีเมลผู้ใช้</label>
                    <input type="text" id="username-input" class="mt-1 w-full p-3 border border-stone-300 rounded-lg shadow-sm focus:ring-2 focus:ring-amber-500">
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-stone-600">รหัสผ่าน</label>
                    <input type="password" id="password-input" class="mt-1 w-full p-3 border border-stone-300 rounded-lg shadow-sm focus:ring-2 focus:ring-amber-500">
                </div>
                <p id="login-error" class="text-sm text-red-600 text-center hidden"></p>
                <button id="login-button" class="w-full bg-amber-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-amber-700 transition-colors">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>
    <div id="app" class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 hidden">
        <header class="relative mb-10 text-center">
            <h1 class="text-4xl font-bold text-stone-900">ระบบจัดการขายยางก้อนถ้วย</h1>
            <p class="text-xl font-semibold text-stone-700 mt-2">สหกรณ์กองทุนสวนยางพาราเกษตรสมบูรณ์ จำกัด</p>
            <p class="text-stone-600 mt-2">ออกใบเสร็จ บันทึกข้อมูล และดูสรุปยอดขายในที่เดียว</p>
            <button id="logout-button" class="absolute top-0 right-0 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition-colors no-print">ออกจากระบบ</button>
        </header>
        <div class="mb-6 border-b border-stone-300 no-print">
            <nav id="tabs" class="flex flex-wrap -mb-px">
                <button data-tab="tab-weighing-consolidated" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">1. รับวางยาง</button>
                <button data-tab="tab-receipt" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">2. ออกใบเสร็จ และ สรุปขึ้นรถ</button>
                <button data-tab="tab-history" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">3. ประวัติและรายงาน</button>
                <button data-tab="tab-dashboard" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">4. สรุปภาพรวม</button>
                <button data-tab="tab-settings" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">5. ตั้งค่า</button>
                <button data-tab="tab-movement-report" class="tab-btn inline-block p-4 border-b-4 border-transparent rounded-t-lg hover:text-amber-600 hover:border-amber-300">6. รายงานการเคลื่อนไหว</button>
            </nav>
        </div>
        <main>
            <div id="tab-weighing-consolidated" class="tab-content">...</div>
            <div id="tab-receipt" class="tab-content">...</div>
            <div id="tab-history" class="tab-content">...</div>
            <div id="tab-dashboard" class="tab-content">...</div>
            <div id="tab-settings" class="tab-content">...</div>

            <div id="tab-movement-report" class="tab-content">
                <section class="bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-stone-800">สรุปยอดขายแยกตามตาชั่ง (วันนี้)</h2>
                        <div id="report-sales-summary-by-scale" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"></div>
                        <div id="report-sales-summary-today-total" class="mt-6 p-4 bg-amber-200 rounded-lg text-center hidden shadow"></div>
                    </div>
                    <div class="border-t pt-8">
                         <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-stone-800">ประวัติการบันทึกน้ำหนักขึ้นรถ (วันนี้)</h2>
                         <div id="report-truck-load-history-container"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <div id="print-area" class="bg-white"></div>
    <div id="modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300 no-print" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300"><div class="p-6"><div class="text-center"><h3 id="modal-title" class="text-lg leading-6 font-bold text-stone-900"></h3><div class="mt-2" id="modal-message-container"><p id="modal-message" class="text-sm text-stone-500"></p></div></div></div><div id="modal-actions" class="bg-stone-50 px-6 py-4 rounded-b-xl flex flex-col-reverse sm:flex-row-reverse sm:gap-3"></div></div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, getDoc, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCNVxG6s46SRXOYAeT0rJHAtz_-3IPUJNE",
            authDomain: "coopksb001.firebaseapp.com",
            projectId: "coopksb001",
            storageBucket: "coopksb001.appspot.com",
            messagingSenderId: "259378610497",
            appId: "1:259378610497:web:fd12679830e97bf5e761c0",
            measurementId: "G-1RHH9TMD73"
        };
        const appId = 'cup-rubber-sales-app';

        const rolePermissions = {
            'admin': ['all'],
            'staff': ['tab-weighing-consolidated', 'tab-receipt'],
            'visitor': ['tab-movement-report']
        };

        let localSalesData = [], localWeighingData = [], localTruckLoads = [], dailyStatsChart, editingId = null, editingWeighingId = null;
        let db, auth, userId, salesCollectionRef, weighingsCollectionRef, truckLoadsCollectionRef, countersDocRef;
        let unsubscribeSales = null, unsubscribeAllWeighings = null, unsubscribeTruckLoads = null, unsubscribeWeighings = {};
        let dailyWeighingData = {}, isPriceLocked = false, isTypeLocked = false, isAppInitialized = false;

        const ui = {
            loginScreen: document.getElementById('login-screen'),
            appContainer: document.getElementById('app'),
            loginButton: document.getElementById('login-button'),
            logoutButton: document.getElementById('logout-button'),
            usernameInput: document.getElementById('username-input'),
            passwordInput: document.getElementById('password-input'),
            loginError: document.getElementById('login-error'),
            tabs: document.getElementById('tabs'),
            weighingHistoryBody: document.getElementById('weighing-history-body'),
            tabContents: document.querySelectorAll('.tab-content'),
            sellerNameInput: document.getElementById('seller-name'),
            sellerNameList: document.getElementById('seller-name-list'),
            receiptDateInput: document.getElementById('receipt-date'),
            dateDisplay: document.getElementById('date-display'),
            selectedReceiptScale: document.getElementById('selected-receipt-scale'),
            receiptScaleSubTabs: document.getElementById('receipt-scale-sub-tabs'),
            receiptBagsCount: document.getElementById('receipt-bags-count'),
            weightInputsContainer: document.getElementById('weight-inputs-container'),
            pricePerKgInput: document.getElementById('price-per-kg'),
            priceLockBtn: document.getElementById('price-lock-btn'),
            priceLockIcon: document.getElementById('price-lock-icon'),
            typeLockBtn: document.getElementById('type-lock-btn'),
            typeLockIcon: document.getElementById('type-lock-icon'),
            receiptTypeContainer: document.getElementById('receipt-type-container'),
            totalWeightEl: document.getElementById('total-weight'),
            totalAmountEl: document.getElementById('total-amount'),
            totalAmountTextEl: document.getElementById('total-amount-text'),
            saveButton: document.getElementById('save-button'),
            cancelEditButton: document.getElementById('cancel-edit-button'),
            salesTableBody: document.getElementById('sales-table-body'),
            searchBox: document.getElementById('search-box'),
            printArea: document.getElementById('print-area'),
            reportDateSelect: document.getElementById('report-date-select'),
            printReportBtn: document.getElementById('print-report-btn'),
            exportExcelBtn: document.getElementById('export-excel-btn'),
            printDashboardBtn: document.getElementById('print-dashboard-btn'),
            dashboardSection: document.getElementById('dashboard'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessageContainer: document.getElementById('modal-message-container'),
            modalMessage: document.getElementById('modal-message'),
            modalActions: document.getElementById('modal-actions'),
            summaryTotalSellers: document.getElementById('summary-total-sellers'),
            summaryTotalWeight: document.getElementById('summary-total-weight'),
            summaryTotalPrice: document.getElementById('summary-total-price'),
            summaryTotalBags: document.getElementById('summary-total-bags'),
            summaryMultiplierWeight: document.getElementById('summary-multiplier-weight'),
            summaryCalculatedWeight: document.getElementById('summary-calculated-weight'),
            deleteAllWeighingsBtn: document.getElementById('delete-all-weighings-btn'),
            salesSummaryByScale: document.getElementById('sales-summary-by-scale'),
            salesSummaryTodayTotal: document.getElementById('sales-summary-today-total'),
            truckSummaryDate: document.getElementById('truck-summary-date'),
            truckSummaryContainer: document.getElementById('truck-summary-container'),
            truckGrandTotalWeight: document.getElementById('truck-grand-total-weight'),
            truckTotalLoadedWeight: document.getElementById('truck-total-loaded-weight'),
            truckLoadHistoryContainer: document.getElementById('truck-load-history-container'),
            weighingSubTabs: document.getElementById('weighing-sub-tabs'),
            receiptSubTabs: document.getElementById('receipt-sub-tabs'),
            reportSalesSummaryByScale: document.getElementById('report-sales-summary-by-scale'),
            reportSalesSummaryTodayTotal: document.getElementById('report-sales-summary-today-total'),
            reportTruckLoadHistoryContainer: document.getElementById('report-truck-load-history-container')
        };
        
        // ... (all other functions, unchanged except for the ones below)

        function applyUserPermissions(userRole) {
            const permissions = rolePermissions[userRole] || [];
            const allTabButtons = document.querySelectorAll('#tabs .tab-btn');
            let firstVisibleTab = null;
            
            ui.appContainer.className = ui.appContainer.className.replace(/app-role-\S+/g, '');
            if(userRole) {
                ui.appContainer.classList.add(`app-role-${userRole}`);
            }

            allTabButtons.forEach(btn => {
                const tabId = btn.dataset.tab;
                if (permissions.includes('all') || permissions.includes(tabId)) {
                    btn.style.display = 'inline-block';
                    if (!firstVisibleTab) firstVisibleTab = tabId;
                } else {
                    btn.style.display = 'none';
                }
            });

            if (firstVisibleTab) {
                switchToTab(firstVisibleTab);
            } else {
                showAlert('คุณไม่มีสิทธิ์เข้าถึงส่วนใดๆ ของระบบ');
            }
        }
        
        function renderTruckLoadHistory(loadsForDay, container, isReadOnly = false) {
            container.innerHTML = '';
            
            if (!isReadOnly) {
                const totalLoadedWeight = loadsForDay.reduce((sum, load) => sum + load.weight, 0);
                ui.truckTotalLoadedWeight.textContent = totalLoadedWeight.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            if (loadsForDay.length === 0) {
                container.innerHTML = '<p class="text-center text-stone-500 py-4">ไม่มีประวัติการบันทึกสำหรับวันที่เลือก</p>';
                return;
            }

            const loadsByScale = loadsForDay.reduce((acc, load) => {
                const scale = load.scaleId;
                if (!acc[scale]) acc[scale] = [];
                acc[scale].push(load);
                return acc;
            }, {});

            const formattedDate = new Date(loadsForDay[0].date.replace(/-/g, '/')).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

            let historyHtml = !isReadOnly ? `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-stone-800 border-b pb-2">ประวัติการบันทึกน้ำหนักขึ้นรถ</h3>
                    <button id="print-truck-history-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-sky-700 transition-colors flex items-center gap-2 no-print">🖨️ พิมพ์ประวัติ</button>
                </div>` : '';
            
            const sortedScales = Object.keys(loadsByScale).sort((a, b) => a - b);
            for (const scaleId of sortedScales) {
                historyHtml += `<div class="mb-4 bg-stone-50 p-4 rounded-lg border">
                    <h4 class="font-bold text-md text-stone-700">ตาชั่งที่ ${scaleId}</h4>
                    <ul class="list-none mt-2 space-y-2 text-stone-600">`;
                loadsByScale[scaleId].sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate()).forEach((load, index) => {
                    const actionButtons = isReadOnly ? '' : `
                        <button class="edit-load-btn text-blue-600 hover:text-blue-800 p-1 rounded-md text-lg no-print" data-id="${load.id}" title="แก้ไข">✏️</button>
                        <button class="delete-load-btn text-red-600 hover:text-red-800 p-1 rounded-md text-lg no-print" data-id="${load.id}" title="ลบ">🗑️</button>`;
                    
                    historyHtml += `<li class="flex justify-between items-center border-b border-stone-200 py-2">
                        <div>
                            <span class="font-medium">ครั้งที่ ${index + 1}:</span>
                            <strong class="text-stone-900 ml-2">${load.weight.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} กก.</strong>
                            <span class="block text-sm text-sky-700 font-semibold">${load.vehicleRegistration || 'ไม่ระบุทะเบียน'}</span>
                            <span class="text-xs text-stone-500">(${load.timestamp.toDate().toLocaleTimeString('th-TH')})</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="view-receipt-list-btn text-blue-600 hover:text-blue-800 p-1 rounded-md text-xl no-print" data-id="${load.id}" title="ดูรายชื่อในล็อตนี้">📋</button>
                            ${actionButtons}
                        </div>
                    </li>`;
                });
                historyHtml += `</ul></div>`;
            }
            container.innerHTML = historyHtml;
            if (!isReadOnly) {
                const totalLoadedWeight = loadsForDay.reduce((sum, load) => sum + load.weight, 0);
                document.getElementById('print-truck-history-btn').addEventListener('click', () => printTruckLoadHistory(loadsByScale, formattedDate, totalLoadedWeight));
            }
        }
        
        function renderScaleSummaries(container, totalContainer) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const salesByScaleToday = localSalesData.reduce((acc, sale) => {
                const saleDate = sale.date.toDate();
                if (saleDate >= today) {
                    const scale = sale.scaleNumber || 'ไม่ระบุ';
                    if (!acc[scale]) acc[scale] = { totalWeight: 0, totalAmount: 0, count: 0 };
                    acc[scale].totalWeight += sale.weight;
                    acc[scale].totalAmount += sale.total;
                    acc[scale].count++;
                }
                return acc;
            }, {});

            container.innerHTML = '';
            if (Object.keys(salesByScaleToday).length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-stone-500 py-4">ไม่มีข้อมูลการขายสำหรับวันนี้</div>';
                if (totalContainer) totalContainer.classList.add('hidden');
                return;
            }

            let totalWeightToday = 0;
            let totalAmountToday = 0;
            const sortedScales = Object.keys(salesByScaleToday).sort((a,b) => a-b);
            for(const scale of sortedScales){
                const summary = salesByScaleToday[scale];
                totalWeightToday += summary.totalWeight;
                totalAmountToday += summary.totalAmount;
                const colors = (parseInt(scale) > 0) ? scaleColorPalette[(parseInt(scale) - 1) % scaleColorPalette.length] : defaultScaleColor;
                container.insertAdjacentHTML('beforeend', `
                    <div class="${colors.bg} border ${colors.border} p-3 rounded-lg text-center shadow-sm">
                        <p class="text-sm font-medium ${colors.textH}">ตาชั่งที่ ${scale}</p>
                        <p class="text-lg font-bold ${colors.textP}">${summary.totalWeight.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})} กก.</p>
                        <p class="text-sm ${colors.textS}">${summary.totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท</p>
                    </div>
                `);
            };

            if (totalContainer) {
                totalContainer.innerHTML = `
                    <h4 class="text-lg font-bold text-amber-800">ยอดรวมทั้งหมด (วันนี้)</h4>
                    <div class="flex justify-center gap-x-8 gap-y-2 flex-wrap mt-2">
                        <div>
                            <span class="text-md text-amber-700">น้ำหนักรวม: </span>
                            <span class="font-bold text-amber-900 text-xl">${totalWeightToday.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            <span class="text-md text-amber-700"> กก.</span>
                        </div>
                        <div>
                            <span class="text-md text-amber-700">ยอดเงินรวม: </span>
                            <span class="font-bold text-amber-900 text-xl">${totalAmountToday.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            <span class="text-md text-amber-700"> บาท</span>
                        </div>
                    </div>`;
                totalContainer.classList.remove('hidden');
            }
        }
        
        // --- Event Listeners and App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // ... (All other event listeners like login, logout, etc.)
            ui.loginButton.addEventListener('click', handleLogin);
            ui.passwordInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleLogin(); });
            ui.logoutButton.addEventListener('click', handleLogout);

            renderWeighingStations();
            ui.tabs.addEventListener('click', (e) => { if (e.target.dataset.tab) switchToTab(e.target.dataset.tab); });
            ui.saveButton.addEventListener('click', handleSave);
            // ... (all other listeners)
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    ui.loginScreen.classList.add('hidden');
                    ui.appContainer.classList.remove('hidden');
                    ui.usernameInput.value = '';

                    const userDocRef = doc(db, 'users', user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    let userRole = null;
                    if (userDocSnap.exists()) {
                        userRole = userDocSnap.data().role;
                    }
                    initializeAppAndListeners(user, userRole);
                } else {
                    ui.loginScreen.classList.remove('hidden');
                    ui.appContainer.classList.add('hidden');
                    cleanupListeners();
                }
            });
        });
    </script>
</body>
</html>
